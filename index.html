<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#ffffff"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="default"/>
  <title>塔羅占卜</title>
  <style>
    /* ==================== CSS VARIABLES ==================== */
    :root {
      /* Colors - 心理學最佳配色 */
      --bg: #fafafa;
      --bg-secondary: #f5f5f7;
      --bg-tertiary: #ffffff;
      --surface: #ffffff;
      --surface-elevated: #ffffff;
      --text: #1d1d1f;
      --text-secondary: #86868b;
      --text-tertiary: #b0b0b5;
      --divider: #e5e5e7;
      --accent: #007aff;
      --accent-hover: #0051d5;
      --accent-active: #004fc4;
      --accent-light: rgba(0, 122, 255, 0.08);
      --success: #34c759;
      --warning: #ff9500;
      --danger: #ff3b30;
      
      /* Suit Colors - 柔和舒適的漸層 */
      --major-arcana-start: #9b59b6;
      --major-arcana-end: #e67e22;
      --wands-start: #e74c3c;
      --wands-end: #f39c12;
      --cups-start: #3498db;
      --cups-end: #16a085;
      --swords-start: #7f8c8d;
      --swords-end: #3498db;
      --pentacles-start: #f39c12;
      --pentacles-end: #27ae60;
      
      /* Shadows - 極致柔和的陰影系統 */
      --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
      --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.04), 0 2px 4px rgba(0, 0, 0, 0.02);
      --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.06), 0 4px 8px rgba(0, 0, 0, 0.03);
      --shadow-xl: 0 12px 24px rgba(0, 0, 0, 0.08), 0 6px 12px rgba(0, 0, 0, 0.04);
      --shadow-2xl: 0 20px 40px rgba(0, 0, 0, 0.1), 0 10px 20px rgba(0, 0, 0, 0.05);
      
      /* Radius - 和諧的圓角系統 */
      --radius-xs: 4px;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      --radius-2xl: 24px;
      --radius-3xl: 32px;
      --radius-full: 9999px;
      
      /* Spacing - 完美的 4px 網格 */
      --space-0: 0;
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-7: 28px;
      --space-8: 32px;
      --space-10: 40px;
      --space-12: 48px;
      --space-14: 56px;
      --space-16: 64px;
      --space-20: 80px;
      --space-24: 96px;
      --space-32: 128px;
      --space-40: 160px;
      --space-48: 192px;
      
      /* Typography - 最佳可讀性 */
      --font-sans: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", "Segoe UI", Roboto, Arial, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      
      /* Font sizes - 1.125 調和比例 */
      --text-2xs: 10px;
      --text-xs: 12px;
      --text-sm: 14px;
      --text-base: 16px;
      --text-lg: 18px;
      --text-xl: 20px;
      --text-2xl: 24px;
      --text-3xl: 30px;
      --text-4xl: 36px;
      --text-5xl: 48px;
      --text-6xl: 60px;
      --text-7xl: 72px;
      
      /* Font weights */
      --weight-light: 300;
      --weight-normal: 400;
      --weight-medium: 500;
      --weight-semibold: 600;
      --weight-bold: 700;
      
      /* Line heights - 最佳閱讀舒適度 */
      --leading-none: 1;
      --leading-tight: 1.25;
      --leading-snug: 1.375;
      --leading-normal: 1.5;
      --leading-relaxed: 1.625;
      --leading-loose: 1.75;
      --leading-extra-loose: 2;
      
      /* Letter spacing */
      --tracking-tighter: -0.05em;
      --tracking-tight: -0.025em;
      --tracking-normal: 0;
      --tracking-wide: 0.025em;
      --tracking-wider: 0.05em;
      --tracking-widest: 0.1em;
      
      /* Transitions - 自然流暢 */
      --duration-instant: 75ms;
      --duration-fast: 150ms;
      --duration-normal: 200ms;
      --duration-slow: 300ms;
      --duration-slower: 500ms;
      --ease-out: cubic-bezier(0, 0, 0.2, 1);
      --ease-in: cubic-bezier(0.4, 0, 1, 1);
      --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);
      --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
      --ease-smooth: cubic-bezier(0.25, 0.46, 0.45, 0.94);
      
      /* Z-index */
      --z-base: 0;
      --z-dropdown: 1000;
      --z-sticky: 1100;
      --z-fixed: 1200;
      --z-modal-backdrop: 1300;
      --z-modal: 1400;
      --z-popover: 1500;
      --z-tooltip: 1600;
      --z-toast: 1700;
    }

    /* Dark mode - OLED 優化 */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #000000;
        --bg-secondary: #0a0a0a;
        --bg-tertiary: #121212;
        --surface: #1c1c1e;
        --surface-elevated: #2c2c2e;
        --text: #f5f5f7;
        --text-secondary: #98989d;
        --text-tertiary: #6e6e73;
        --divider: #2c2c2e;
        --accent-light: rgba(0, 122, 255, 0.15);
        --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.5);
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.6), 0 1px 2px rgba(0, 0, 0, 0.5);
        --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.7), 0 2px 4px rgba(0, 0, 0, 0.6);
        --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.8), 0 4px 8px rgba(0, 0, 0, 0.7);
        --shadow-xl: 0 12px 24px rgba(0, 0, 0, 0.85), 0 6px 12px rgba(0, 0, 0, 0.8);
        --shadow-2xl: 0 20px 40px rgba(0, 0, 0, 0.9), 0 10px 20px rgba(0, 0, 0, 0.85);
      }
    }

    .light {
      --bg: #fafafa;
      --bg-secondary: #f5f5f7;
      --bg-tertiary: #ffffff;
      --surface: #ffffff;
      --surface-elevated: #ffffff;
      --text: #1d1d1f;
      --text-secondary: #86868b;
      --text-tertiary: #b0b0b5;
      --divider: #e5e5e7;
      --accent-light: rgba(0, 122, 255, 0.08);
      --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
      --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.04), 0 2px 4px rgba(0, 0, 0, 0.02);
      --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.06), 0 4px 8px rgba(0, 0, 0, 0.03);
      --shadow-xl: 0 12px 24px rgba(0, 0, 0, 0.08), 0 6px 12px rgba(0, 0, 0, 0.04);
      --shadow-2xl: 0 20px 40px rgba(0, 0, 0, 0.1), 0 10px 20px rgba(0, 0, 0, 0.05);
    }

    .dark {
      --bg: #000000;
      --bg-secondary: #0a0a0a;
      --bg-tertiary: #121212;
      --surface: #1c1c1e;
      --surface-elevated: #2c2c2e;
      --text: #f5f5f7;
      --text-secondary: #98989d;
      --text-tertiary: #6e6e73;
      --divider: #2c2c2e;
      --accent-light: rgba(0, 122, 255, 0.15);
      --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.5);
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.6), 0 1px 2px rgba(0, 0, 0, 0.5);
      --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.7), 0 2px 4px rgba(0, 0, 0, 0.6);
      --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.8), 0 4px 8px rgba(0, 0, 0, 0.7);
      --shadow-xl: 0 12px 24px rgba(0, 0, 0, 0.85), 0 6px 12px rgba(0, 0, 0, 0.8);
      --shadow-2xl: 0 20px 40px rgba(0, 0, 0, 0.9), 0 10px 20px rgba(0, 0, 0, 0.85);
    }

    /* ==================== BASE RESET ==================== */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    html {
      font-size: 16px;
      scroll-behavior: smooth;
      text-size-adjust: 100%;
      -webkit-text-size-adjust: 100%;
      overflow-x: hidden;
    }

    body {
      font-family: var(--font-sans);
      font-size: var(--text-base);
      line-height: var(--leading-normal);
      color: var(--text);
      background: var(--bg);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      overflow-x: hidden;
      transition: background-color var(--duration-slow) var(--ease-out);
      min-height: 100vh;
      position: relative;
    }

    /* ==================== HEADER ==================== */
    .app-header {
      position: sticky;
      top: 0;
      z-index: var(--z-sticky);
      background: rgba(250, 250, 250, 0.85);
      backdrop-filter: saturate(180%) blur(20px);
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      border-bottom: 1px solid var(--divider);
      transition: all var(--duration-normal) var(--ease-out);
    }

    .dark .app-header {
      background: rgba(0, 0, 0, 0.85);
    }

    .header-inner {
      max-width: 1280px;
      margin: 0 auto;
      padding: var(--space-0) var(--space-5);
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-4);
    }

    @media (min-width: 640px) {
      .header-inner {
        padding: var(--space-0) var(--space-6);
        height: 60px;
      }
    }

    @media (min-width: 768px) {
      .header-inner {
        padding: var(--space-0) var(--space-8);
        height: 64px;
      }
    }

    @media (min-width: 1024px) {
      .header-inner {
        max-width: 1440px;
        padding: var(--space-0) var(--space-12);
      }
    }

    .title h1 {
      font-size: var(--text-xl);
      font-weight: var(--weight-semibold);
      letter-spacing: var(--tracking-tight);
      color: var(--text);
      line-height: var(--leading-none);
    }

    @media (min-width: 640px) {
      .title h1 {
        font-size: var(--text-2xl);
      }
    }

    @media (min-width: 1024px) {
      .title h1 {
        font-size: var(--text-3xl);
      }
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .icon-btn {
      appearance: none;
      border: none;
      background: transparent;
      width: 40px;
      height: 40px;
      padding: var(--space-0);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all var(--duration-fast) var(--ease-out);
      border-radius: var(--radius-md);
      position: relative;
    }

    @media (min-width: 768px) {
      .icon-btn {
        width: 44px;
        height: 44px;
      }
    }

    .icon-btn:hover {
      color: var(--text);
      background: var(--bg-secondary);
    }

    .icon-btn:active {
      transform: scale(0.94);
    }

    .icon {
      width: 22px;
      height: 22px;
      position: relative;
      z-index: 1;
      pointer-events: none;
    }

    @media (min-width: 768px) {
      .icon {
        width: 24px;
        height: 24px;
      }
    }

    /* ==================== HERO ==================== */
    .hero {
      background: var(--bg);
      padding: var(--space-20) var(--space-5) var(--space-16);
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    @media (min-width: 640px) {
      .hero {
        padding: var(--space-24) var(--space-6) var(--space-20);
      }
    }

    @media (min-width: 768px) {
      .hero {
        padding: var(--space-32) var(--space-8) var(--space-24);
      }
    }

    @media (min-width: 1024px) {
      .hero {
        padding: var(--space-40) var(--space-12) var(--space-32);
      }
    }

    .hero::before {
      content: '';
      position: absolute;
      top: -50%;
      left: 50%;
      transform: translateX(-50%);
      width: 150%;
      height: 200%;
      background: radial-gradient(circle at center, rgba(0, 122, 255, 0.025) 0%, transparent 70%);
      animation: heroGlow 20s ease-in-out infinite;
      pointer-events: none;
    }

    @keyframes heroGlow {
      0%, 100% { 
        transform: translateX(-50%) scale(1); 
        opacity: 0.3; 
      }
      50% { 
        transform: translateX(-50%) scale(1.05); 
        opacity: 0.5; 
      }
    }

    .hero-title {
      font-size: var(--text-4xl);
      font-weight: var(--weight-semibold);
      letter-spacing: var(--tracking-tighter);
      line-height: var(--leading-tight);
      margin-bottom: var(--space-5);
      color: var(--text);
      position: relative;
      z-index: 1;
    }

    @media (min-width: 640px) {
      .hero-title {
        font-size: var(--text-5xl);
        margin-bottom: var(--space-6);
      }
    }

    @media (min-width: 768px) {
      .hero-title {
        font-size: var(--text-6xl);
      }
    }

    @media (min-width: 1024px) {
      .hero-title {
        font-size: var(--text-7xl);
        margin-bottom: var(--space-8);
      }
    }

    .hero-subtitle {
      font-size: var(--text-base);
      font-weight: var(--weight-normal);
      color: var(--text-secondary);
      line-height: var(--leading-relaxed);
      max-width: 560px;
      margin: var(--space-0) auto;
      position: relative;
      z-index: 1;
    }

    @media (min-width: 640px) {
      .hero-subtitle {
        font-size: var(--text-lg);
        max-width: 640px;
      }
    }

    @media (min-width: 768px) {
      .hero-subtitle {
        font-size: var(--text-xl);
        max-width: 720px;
      }
    }

    /* ==================== CONTAINER ==================== */
    .container {
      max-width: 1280px;
      margin: var(--space-0) auto;
      padding: var(--space-0) var(--space-5) var(--space-24);
    }

    @media (min-width: 640px) {
      .container {
        padding: var(--space-0) var(--space-6) var(--space-32);
      }
    }

    @media (min-width: 768px) {
      .container {
        padding: var(--space-0) var(--space-8) var(--space-40);
      }
    }

    @media (min-width: 1024px) {
      .container {
        max-width: 1440px;
        padding: var(--space-0) var(--space-12) var(--space-48);
      }
    }

    /* ==================== TABS ==================== */
    .tabs {
      display: flex;
      gap: var(--space-6);
      justify-content: center;
      margin-bottom: var(--space-12);
      border-bottom: 1.5px solid var(--divider);
      overflow-x: auto;
      scrollbar-width: none;
      -webkit-overflow-scrolling: touch;
      padding: var(--space-0) var(--space-2);
    }

    .tabs::-webkit-scrollbar {
      display: none;
    }

    @media (min-width: 640px) {
      .tabs {
        gap: var(--space-8);
        margin-bottom: var(--space-16);
      }
    }

    @media (min-width: 768px) {
      .tabs {
        gap: var(--space-10);
      }
    }

    .tab {
      appearance: none;
      border: none;
      background: transparent;
      font-size: var(--text-sm);
      font-weight: var(--weight-medium);
      color: var(--text-secondary);
      padding: var(--space-4) var(--space-2) var(--space-4);
      cursor: pointer;
      border-bottom: 2.5px solid transparent;
      transition: all var(--duration-normal) var(--ease-out);
      white-space: nowrap;
      position: relative;
      letter-spacing: var(--tracking-normal);
    }

    @media (min-width: 640px) {
      .tab {
        font-size: var(--text-base);
        padding: var(--space-4) var(--space-3) var(--space-5);
      }
    }

    .tab:hover {
      color: var(--text);
    }

    .tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    /* ==================== PANEL ==================== */
    .panel {
      background: var(--surface);
      border-radius: var(--radius-2xl);
      padding: var(--space-6);
      box-shadow: var(--shadow-sm);
      margin-bottom: var(--space-12);
      transition: all var(--duration-slow) var(--ease-out);
      border: 1px solid var(--divider);
    }

    @media (min-width: 640px) {
      .panel {
        padding: var(--space-8);
        border-radius: var(--radius-3xl);
      }
    }

    @media (min-width: 768px) {
      .panel {
        padding: var(--space-10);
      }
    }

    @media (min-width: 1024px) {
      .panel {
        padding: var(--space-12);
      }
    }

    .panel:hover {
      box-shadow: var(--shadow-md);
    }

    /* ==================== FORMS ==================== */
    .form-section {
      margin-bottom: var(--space-0);
    }

    .form-grid {
      display: grid;
      gap: var(--space-5);
      margin-bottom: var(--space-8);
    }

    @media (min-width: 768px) {
      .form-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-6);
      }
    }

    @media (min-width: 1024px) {
      .form-grid {
        gap: var(--space-8);
      }
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .form-field.full {
      grid-column: 1 / -1;
    }

    label {
      font-size: var(--text-sm);
      font-weight: var(--weight-medium);
      color: var(--text-secondary);
      letter-spacing: var(--tracking-normal);
      line-height: var(--leading-tight);
    }

    @media (min-width: 768px) {
      label {
        font-size: var(--text-base);
      }
    }

    input[type="text"],
    select,
    textarea {
      appearance: none;
      width: 100%;
      font-family: var(--font-sans);
      font-size: var(--text-base);
      color: var(--text);
      background: var(--bg-secondary);
      border: 1.5px solid transparent;
      border-radius: var(--radius-lg);
      padding: var(--space-4) var(--space-5);
      outline: none;
      transition: all var(--duration-normal) var(--ease-out);
      line-height: var(--leading-normal);
      min-height: 48px;
    }

    @media (min-width: 768px) {
      input[type="text"],
      select,
      textarea {
        min-height: 52px;
        padding: var(--space-5) var(--space-6);
      }
    }

    textarea {
      min-height: 120px;
      resize: vertical;
      padding-top: var(--space-4);
      padding-bottom: var(--space-4);
    }

    input[type="text"]:focus,
    select:focus,
    textarea:focus {
      background: var(--surface);
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-light);
    }

    input[type="text"]::placeholder,
    textarea::placeholder {
      color: var(--text-tertiary);
    }

    select {
      cursor: pointer;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%2386868b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
      background-position: right var(--space-4) center;
      background-repeat: no-repeat;
      background-size: 20px;
      padding-right: var(--space-12);
    }

    /* ==================== BUTTONS ==================== */
    .btn-group {
      display: flex;
      gap: var(--space-3);
      flex-wrap: wrap;
      align-items: stretch;
    }

    @media (min-width: 640px) {
      .btn-group {
        gap: var(--space-4);
      }
    }

    .btn {
      appearance: none;
      border: none;
      font-family: var(--font-sans);
      font-size: var(--text-base);
      font-weight: var(--weight-medium);
      letter-spacing: var(--tracking-normal);
      padding: var(--space-0) var(--space-8);
      min-height: 52px;
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: all var(--duration-normal) var(--ease-out);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      white-space: nowrap;
      position: relative;
      overflow: hidden;
      line-height: var(--leading-tight);
    }

    @media (min-width: 768px) {
      .btn {
        min-height: 56px;
        padding: var(--space-0) var(--space-10);
      }
    }

    .btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: currentColor;
      opacity: 0;
      transition: opacity var(--duration-instant) var(--ease-out);
    }

    .btn:active::before {
      opacity: 0.1;
    }

    .btn-primary {
      background: var(--accent);
      color: #ffffff;
      flex: 1 1 auto;
      min-width: 200px;
      box-shadow: 0 2px 12px rgba(0, 122, 255, 0.25);
    }

    .btn-primary:hover {
      background: var(--accent-hover);
      box-shadow: 0 4px 16px rgba(0, 122, 255, 0.35);
      transform: translateY(-1px);
    }

    .btn-primary:active {
      background: var(--accent-active);
      transform: translateY(0);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: transparent;
      color: var(--accent);
      border: 1.5px solid var(--accent);
      box-shadow: none;
    }

    .btn-secondary:hover {
      background: var(--accent-light);
    }

    .btn-tertiary {
      background: var(--bg-secondary);
      color: var(--text);
      box-shadow: var(--shadow-xs);
    }

    .btn-tertiary:hover {
      background: var(--divider);
      box-shadow: var(--shadow-sm);
    }

    .btn-sm {
      padding: var(--space-0) var(--space-5);
      font-size: var(--text-sm);
      min-height: 40px;
    }

    @media (min-width: 768px) {
      .btn-sm {
        min-height: 44px;
        padding: var(--space-0) var(--space-6);
      }
    }

    /* ==================== SPREAD INFO ==================== */
    .spread-info {
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      padding: var(--space-5);
      margin-top: var(--space-8);
      border: 1px solid var(--divider);
    }

    @media (min-width: 640px) {
      .spread-info {
        padding: var(--space-6);
      }
    }

    @media (min-width: 768px) {
      .spread-info {
        padding: var(--space-8);
        border-radius: var(--radius-2xl);
      }
    }

    .spread-info-title {
      font-size: var(--text-base);
      font-weight: var(--weight-semibold);
      margin-bottom: var(--space-4);
      color: var(--text);
      display: flex;
      align-items: center;
      gap: var(--space-2);
      line-height: var(--leading-tight);
    }

    @media (min-width: 768px) {
      .spread-info-title {
        font-size: var(--text-lg);
        margin-bottom: var(--space-5);
      }
    }

    .spread-info-content {
      font-size: var(--text-sm);
      color: var(--text-secondary);
      line-height: var(--leading-relaxed);
      margin-bottom: var(--space-6);
    }

    @media (min-width: 768px) {
      .spread-info-content {
        font-size: var(--text-base);
      }
    }

    .spread-positions-title {
      font-size: var(--text-sm);
      font-weight: var(--weight-semibold);
      margin-bottom: var(--space-3);
      color: var(--text);
      line-height: var(--leading-tight);
    }

    @media (min-width: 768px) {
      .spread-positions-title {
        font-size: var(--text-base);
        margin-bottom: var(--space-4);
      }
    }

    .spread-positions-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .spread-position-item {
      display: flex;
      gap: var(--space-3);
      font-size: var(--text-sm);
      color: var(--text-secondary);
      line-height: var(--leading-relaxed);
    }

    .spread-position-num {
      color: var(--accent);
      font-weight: var(--weight-semibold);
      min-width: 32px;
      flex-shrink: 0;
    }

    /* ==================== RESULTS ==================== */
    .results {
      margin-top: var(--space-16);
    }

    .results-header {
      text-align: center;
      margin-bottom: var(--space-12);
    }

    @media (min-width: 768px) {
      .results-header {
        margin-bottom: var(--space-16);
      }
    }

    .results-title {
      font-size: var(--text-3xl);
      font-weight: var(--weight-semibold);
      letter-spacing: var(--tracking-tighter);
      margin-bottom: var(--space-5);
      color: var(--text);
      line-height: var(--leading-tight);
    }

    @media (min-width: 640px) {
      .results-title {
        font-size: var(--text-4xl);
      }
    }

    @media (min-width: 768px) {
      .results-title {
        font-size: var(--text-5xl);
        margin-bottom: var(--space-6);
      }
    }

    .results-meta {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-4);
      flex-wrap: wrap;
      font-size: var(--text-sm);
      color: var(--text-secondary);
    }

    @media (min-width: 768px) {
      .results-meta {
        font-size: var(--text-base);
        gap: var(--space-5);
      }
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      background: var(--bg-secondary);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--weight-medium);
      color: var(--text-secondary);
      letter-spacing: var(--tracking-wide);
      text-transform: uppercase;
      line-height: var(--leading-none);
    }

    @media (min-width: 768px) {
      .badge {
        padding: var(--space-3) var(--space-5);
        font-size: var(--text-sm);
      }
    }

    .badge.favorite {
      background: rgba(255, 149, 0, 0.1);
      color: var(--warning);
    }

    /* ==================== CARDS GRID ==================== */
    .cards-grid {
      display: grid;
      gap: var(--space-5);
      margin-bottom: var(--space-10);
    }

    @media (min-width: 640px) {
      .cards-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-6);
      }
    }

    @media (min-width: 1024px) {
      .cards-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: var(--space-8);
      }
    }

    /* ==================== CARD STYLES (TEXT MODE - DEFAULT) ==================== */
    .card {
      background: var(--surface);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      box-shadow: var(--shadow-sm);
      transition: all var(--duration-slow) var(--ease-out);
      cursor: pointer;
      border: 1px solid var(--divider);
      position: relative;
      min-height: 200px;
      display: flex;
      flex-direction: column;
    }

    @media (min-width: 640px) {
      .card {
        padding: var(--space-7);
        border-radius: var(--radius-2xl);
      }
    }

    @media (min-width: 768px) {
      .card {
        padding: var(--space-8);
        min-height: 240px;
      }
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: transparent;
    }

    .card:active {
      transform: translateY(-2px);
    }

    .card-position {
      font-size: var(--text-xs);
      font-weight: var(--weight-semibold);
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: var(--tracking-wider);
      margin-bottom: var(--space-4);
      line-height: var(--leading-none);
    }

    @media (min-width: 768px) {
      .card-position {
        font-size: var(--text-sm);
        margin-bottom: var(--space-5);
      }
    }

    .card-content {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: var(--space-4);
      margin-bottom: auto;
      padding-bottom: var(--space-6);
    }

    .card-name {
      font-size: var(--text-xl);
      font-weight: var(--weight-semibold);
      color: var(--text);
      letter-spacing: var(--tracking-tight);
      line-height: var(--leading-snug);
      flex: 1;
    }

    @media (min-width: 640px) {
      .card-name {
        font-size: var(--text-2xl);
      }
    }

    @media (min-width: 768px) {
      .card-name {
        font-size: var(--text-3xl);
      }
    }

    .card-orientation {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--text-sm);
      color: var(--text-secondary);
      white-space: nowrap;
      flex-shrink: 0;
      line-height: var(--leading-tight);
    }

    .ori-icon {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      border: 2.5px solid currentColor;
      transition: transform var(--duration-slow) var(--ease-spring);
      flex-shrink: 0;
    }

    .ori-icon.reversed {
      transform: rotate(180deg);
    }

    .card-footer {
      display: flex;
      justify-content: space-between;
      padding-top: var(--space-4);
      border-top: 1px solid var(--divider);
      font-size: var(--text-xs);
      color: var(--text-tertiary);
      line-height: var(--leading-tight);
      margin-top: auto;
    }

    @media (min-width: 768px) {
      .card-footer {
        font-size: var(--text-sm);
        padding-top: var(--space-5);
      }
    }

    .card.bottom {
      background: linear-gradient(135deg, 
        rgba(0, 122, 255, 0.04), 
        rgba(0, 122, 255, 0.01));
      border-color: rgba(0, 122, 255, 0.2);
    }

    /* ==================== VISUAL CARD MODES ==================== */
    
    /* CSS Gradient Mode */
    .card.visual-css {
      min-height: 320px;
      background: linear-gradient(135deg, var(--card-gradient-start), var(--card-gradient-end));
      border: 2px solid rgba(255, 255, 255, 0.1);
      position: relative;
      overflow: hidden;
    }

    @media (min-width: 768px) {
      .card.visual-css {
        min-height: 360px;
      }
    }

    .card.visual-css::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.15) 0%, transparent 60%);
      opacity: 0;
      transition: opacity var(--duration-slower) var(--ease-out);
    }

    .card.visual-css:hover::before {
      opacity: 1;
    }

    .card.visual-css .card-visual-number {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 100px;
      font-weight: var(--weight-bold);
      color: rgba(255, 255, 255, 0.12);
      line-height: 1;
      pointer-events: none;
      z-index: 0;
    }

    @media (min-width: 640px) {
      .card.visual-css .card-visual-number {
        font-size: 120px;
      }
    }

    @media (min-width: 768px) {
      .card.visual-css .card-visual-number {
        font-size: 140px;
      }
    }

    .card.visual-css .card-visual-emoji {
      position: absolute;
      bottom: var(--space-6);
      right: var(--space-6);
      font-size: 48px;
      opacity: 0.9;
      filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.2));
    }

    @media (min-width: 768px) {
      .card.visual-css .card-visual-emoji {
        font-size: 56px;
        bottom: var(--space-8);
        right: var(--space-8);
      }
    }

    .card.visual-css .card-position,
    .card.visual-css .card-name,
    .card.visual-css .card-orientation,
    .card.visual-css .card-footer {
      position: relative;
      z-index: 1;
      color: rgba(255, 255, 255, 0.95);
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    .card.visual-css .card-position {
      color: rgba(255, 255, 255, 0.85);
    }

    .card.visual-css .card-footer {
      border-top-color: rgba(255, 255, 255, 0.25);
      color: rgba(255, 255, 255, 0.75);
    }

    /* Emoji Mode */
    .card.visual-emoji .card-emoji-large {
      font-size: 72px;
      text-align: center;
      margin: var(--space-8) var(--space-0);
      filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.1));
    }

    @media (min-width: 640px) {
      .card.visual-emoji .card-emoji-large {
        font-size: 80px;
      }
    }

    @media (min-width: 768px) {
      .card.visual-emoji .card-emoji-large {
        font-size: 96px;
        margin: var(--space-10) var(--space-0);
      }
    }

    /* API Image Mode */
    .card.visual-api {
      min-height: 360px;
      padding: var(--space-0);
      overflow: hidden;
    }

    @media (min-width: 768px) {
      .card.visual-api {
        min-height: 400px;
      }
    }

    .card.visual-api .card-image-container {
      width: 100%;
      height: 200px;
      overflow: hidden;
      position: relative;
      background: var(--bg-secondary);
    }

    @media (min-width: 640px) {
      .card.visual-api .card-image-container {
        height: 220px;
      }
    }

    @media (min-width: 768px) {
      .card.visual-api .card-image-container {
        height: 240px;
      }
    }

    .card.visual-api .card-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform var(--duration-slower) var(--ease-out);
    }

    .card.visual-api:hover .card-image {
      transform: scale(1.05);
    }

    .card.visual-api .card-image-loading {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-secondary);
      color: var(--text-tertiary);
      font-size: var(--text-sm);
    }

    .card.visual-api .card-info {
      padding: var(--space-6);
      display: flex;
      flex-direction: column;
      min-height: 160px;
    }

    @media (min-width: 640px) {
      .card.visual-api .card-info {
        padding: var(--space-7);
      }
    }

    @media (min-width: 768px) {
      .card.visual-api .card-info {
        padding: var(--space-8);
        min-height: 160px;
      }
    }

    /* ==================== CARD NOTES ==================== */
    .card-notes {
      margin-top: var(--space-6);
      padding: var(--space-5);
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      border-left: 3px solid var(--accent);
      font-size: var(--text-sm);
      color: var(--text-secondary);
      font-style: italic;
      line-height: var(--leading-relaxed);
    }

    @media (min-width: 768px) {
      .card-notes {
        padding: var(--space-6);
        font-size: var(--text-base);
      }
    }

    /* ==================== TAGS ==================== */
    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
      margin-top: var(--space-4);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-2) var(--space-3);
      background: var(--bg-secondary);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-out);
      line-height: var(--leading-none);
      border: 1px solid transparent;
    }

    @media (min-width: 768px) {
      .tag {
        padding: var(--space-2) var(--space-4);
        font-size: var(--text-sm);
      }
    }

    .tag:hover {
      background: var(--divider);
      border-color: var(--divider);
    }

    .tag.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    /* ==================== HISTORY ==================== */
    .history-controls {
      display: flex;
      gap: var(--space-3);
      margin-bottom: var(--space-6);
      flex-wrap: wrap;
    }

    @media (min-width: 768px) {
      .history-controls {
        gap: var(--space-4);
      }
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
      max-height: 70vh;
      overflow-y: auto;
      padding: var(--space-1);
    }

    @media (min-width: 768px) {
      .history-list {
        gap: var(--space-5);
      }
    }

    .history-item {
      background: var(--surface);
      border-radius: var(--radius-xl);
      padding: var(--space-5);
      box-shadow: var(--shadow-sm);
      cursor: pointer;
      transition: all var(--duration-normal) var(--ease-out);
      border: 1px solid var(--divider);
      position: relative;
    }

    @media (min-width: 640px) {
      .history-item {
        padding: var(--space-6);
        border-radius: var(--radius-2xl);
      }
    }

    @media (min-width: 768px) {
      .history-item {
        padding: var(--space-7);
      }
    }

    .history-item:hover {
      border-color: var(--accent);
      transform: translateX(4px);
      box-shadow: var(--shadow-md);
    }

    .history-item.favorite::before {
      content: '⭐';
      position: absolute;
      top: var(--space-5);
      right: var(--space-5);
      font-size: var(--text-lg);
    }

    @media (min-width: 768px) {
      .history-item.favorite::before {
        top: var(--space-7);
        right: var(--space-7);
        font-size: var(--text-xl);
      }
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-4);
      margin-bottom: var(--space-3);
    }

    .history-spread {
      font-weight: var(--weight-semibold);
      color: var(--text);
      font-size: var(--text-base);
      line-height: var(--leading-tight);
    }

    @media (min-width: 768px) {
      .history-spread {
        font-size: var(--text-lg);
      }
    }

    .history-time {
      font-size: var(--text-xs);
      color: var(--text-tertiary);
      line-height: var(--leading-tight);
    }

    @media (min-width: 768px) {
      .history-time {
        font-size: var(--text-sm);
      }
    }

    .history-question {
      font-size: var(--text-sm);
      color: var(--text-secondary);
      font-style: italic;
      margin-bottom: var(--space-3);
      line-height: var(--leading-relaxed);
    }

    @media (min-width: 768px) {
      .history-question {
        font-size: var(--text-base);
      }
    }

    .history-actions {
      display: flex;
      gap: var(--space-2);
      margin-top: var(--space-5);
      padding-top: var(--space-5);
      border-top: 1px solid var(--divider);
      flex-wrap: wrap;
    }

    @media (min-width: 768px) {
      .history-actions {
        gap: var(--space-3);
      }
    }

    .history-empty {
      text-align: center;
      color: var(--text-secondary);
      padding: var(--space-24) var(--space-6);
      font-size: var(--text-base);
      line-height: var(--leading-relaxed);
    }

    @media (min-width: 768px) {
      .history-empty {
        font-size: var(--text-lg);
        padding: var(--space-32) var(--space-8);
      }
    }

    /* ==================== STATISTICS ==================== */
    .stats-grid {
      display: grid;
      gap: var(--space-5);
    }

    @media (min-width: 640px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-6);
      }
    }

    @media (min-width: 1024px) {
      .stats-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: var(--space-8);
      }
    }

    .stat-card {
      background: var(--surface);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      box-shadow: var(--shadow-sm);
      transition: all var(--duration-slow) var(--ease-out);
      border: 1px solid var(--divider);
    }

    @media (min-width: 640px) {
      .stat-card {
        padding: var(--space-7);
        border-radius: var(--radius-2xl);
      }
    }

    @media (min-width: 768px) {
      .stat-card {
        padding: var(--space-8);
      }
    }

    .stat-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .stat-title {
      font-size: var(--text-xs);
      font-weight: var(--weight-semibold);
      color: var(--text-secondary);
      margin-bottom: var(--space-4);
      text-transform: uppercase;
      letter-spacing: var(--tracking-wider);
      line-height: var(--leading-tight);
    }

    @media (min-width: 768px) {
      .stat-title {
        font-size: var(--text-sm);
        margin-bottom: var(--space-5);
      }
    }

    .stat-value {
      font-size: var(--text-4xl);
      font-weight: var(--weight-semibold);
      color: var(--text);
      line-height: var(--leading-none);
      margin-bottom: var(--space-3);
      letter-spacing: var(--tracking-tighter);
    }

    @media (min-width: 640px) {
      .stat-value {
        font-size: var(--text-5xl);
      }
    }

    @media (min-width: 768px) {
      .stat-value {
        font-size: var(--text-6xl);
      }
    }

    .stat-label {
      font-size: var(--text-sm);
      color: var(--text-tertiary);
      line-height: var(--leading-tight);
    }

    .stat-card.wide {
      grid-column: 1 / -1;
    }

    .stat-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
      margin-top: var(--space-6);
    }

    @media (min-width: 768px) {
      .stat-list {
        gap: var(--space-4);
      }
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-4);
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      transition: all var(--duration-fast) var(--ease-out);
    }

    @media (min-width: 768px) {
      .stat-item {
        padding: var(--space-5);
        border-radius: var(--radius-lg);
      }
    }

    .stat-item:hover {
      background: var(--divider);
    }

    .stat-item-name {
      font-weight: var(--weight-medium);
      color: var(--text);
      font-size: var(--text-sm);
      line-height: var(--leading-tight);
    }

    @media (min-width: 768px) {
      .stat-item-name {
        font-size: var(--text-base);
      }
    }

    .stat-item-count {
      color: var(--accent);
      font-weight: var(--weight-semibold);
      font-size: var(--text-sm);
      line-height: var(--leading-tight);
    }

    @media (min-width: 768px) {
      .stat-item-count {
        font-size: var(--text-base);
      }
    }

    /* ==================== CHARTS ==================== */
    .trend-chart {
      height: 120px;
      display: flex;
      align-items: flex-end;
      gap: 2px;
      margin-top: var(--space-6);
      padding: var(--space-5);
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      border: 1px solid var(--divider);
    }

    @media (min-width: 640px) {
      .trend-chart {
        height: 140px;
      }
    }

    @media (min-width: 768px) {
      .trend-chart {
        height: 160px;
        padding: var(--space-6);
      }
    }

    .trend-bar {
      flex: 1;
      background: var(--accent);
      border-radius: 3px 3px 0 0;
      transition: all var(--duration-normal) var(--ease-out);
      min-height: 2px;
      opacity: 0.7;
    }

    .trend-bar:hover {
      opacity: 1;
      transform: scaleY(1.1);
      transform-origin: bottom;
    }

    .pie-chart {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-8);
      margin-top: var(--space-6);
      flex-wrap: wrap;
    }

    @media (min-width: 768px) {
      .pie-chart {
        gap: var(--space-10);
      }
    }

    .pie-canvas {
      width: 200px;
      height: 200px;
    }

    @media (min-width: 640px) {
      .pie-canvas {
        width: 220px;
        height: 220px;
      }
    }

    @media (min-width: 768px) {
      .pie-canvas {
        width: 240px;
        height: 240px;
      }
    }

    .pie-legend {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    @media (min-width: 768px) {
      .pie-legend {
        gap: var(--space-4);
      }
    }

    .pie-legend-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      font-size: var(--text-sm);
      line-height: var(--leading-tight);
    }

    @media (min-width: 768px) {
      .pie-legend-item {
        font-size: var(--text-base);
      }
    }

    .pie-legend-color {
      width: 20px;
      height: 20px;
      border-radius: var(--radius-xs);
      flex-shrink: 0;
    }

    /* ==================== CARD DATABASE ==================== */
    .search-field {
      margin-bottom: var(--space-6);
    }

    .card-db-grid {
      display: grid;
      gap: var(--space-4);
      max-height: 70vh;
      overflow-y: auto;
      padding: var(--space-1);
    }

    @media (min-width: 640px) {
      .card-db-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-5);
      }
    }

    @media (min-width: 1024px) {
      .card-db-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: var(--space-6);
      }
    }

    .card-db-item {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: var(--space-5);
      box-shadow: var(--shadow-sm);
      transition: all var(--duration-normal) var(--ease-out);
      border: 1px solid var(--divider);
    }

    @media (min-width: 640px) {
      .card-db-item {
        padding: var(--space-6);
        border-radius: var(--radius-xl);
      }
    }

    @media (min-width: 768px) {
      .card-db-item {
        padding: var(--space-7);
      }
    }

    .card-db-item:hover {
      border-color: var(--accent);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .card-db-number {
      font-size: var(--text-xs);
      font-weight: var(--weight-semibold);
      color: var(--accent);
      margin-bottom: var(--space-3);
      line-height: var(--leading-none);
    }

    @media (min-width: 768px) {
      .card-db-number {
        font-size: var(--text-sm);
      }
    }

    .card-db-name {
      font-size: var(--text-lg);
      font-weight: var(--weight-semibold);
      color: var(--text);
      margin-bottom: var(--space-2);
      line-height: var(--leading-tight);
    }

    @media (min-width: 768px) {
      .card-db-name {
        font-size: var(--text-xl);
      }
    }

    .card-db-english {
      font-size: var(--text-sm);
      color: var(--text-secondary);
      margin-bottom: var(--space-4);
      line-height: var(--leading-tight);
    }

    @media (min-width: 768px) {
      .card-db-english {
        font-size: var(--text-base);
      }
    }

    .card-db-suit {
      display: inline-block;
      padding: var(--space-2) var(--space-3);
      background: var(--bg-secondary);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      color: var(--text-tertiary);
      line-height: var(--leading-none);
    }

    @media (min-width: 768px) {
      .card-db-suit {
        padding: var(--space-2) var(--space-4);
        font-size: var(--text-sm);
      }
    }

    /* ==================== SETTINGS ==================== */
    .settings-section {
      margin-bottom: var(--space-10);
    }

    @media (min-width: 768px) {
      .settings-section {
        margin-bottom: var(--space-12);
      }
    }

    .settings-section:last-child {
      margin-bottom: var(--space-0);
    }

    .settings-title {
      font-size: var(--text-lg);
      font-weight: var(--weight-semibold);
      margin-bottom: var(--space-6);
      color: var(--text);
      line-height: var(--leading-tight);
    }

    @media (min-width: 768px) {
      .settings-title {
        font-size: var(--text-xl);
      }
    }

    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }

    @media (min-width: 768px) {
      .checkbox-group {
        gap: var(--space-5);
      }
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      padding: var(--space-4);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: background var(--duration-fast) var(--ease-out);
    }

    @media (min-width: 768px) {
      .checkbox-item {
        padding: var(--space-5);
        border-radius: var(--radius-lg);
      }
    }

    .checkbox-item:hover {
      background: var(--bg-secondary);
    }

    .checkbox-item input[type="checkbox"],
    .checkbox-item input[type="radio"] {
      width: 22px;
      height: 22px;
      cursor: pointer;
      accent-color: var(--accent);
      flex-shrink: 0;
    }

    @media (min-width: 768px) {
      .checkbox-item input[type="checkbox"],
      .checkbox-item input[type="radio"] {
        width: 24px;
        height: 24px;
      }
    }

    .checkbox-label {
      font-size: var(--text-sm);
      cursor: pointer;
      color: var(--text);
      line-height: var(--leading-tight);
    }

    @media (min-width: 768px) {
      .checkbox-label {
        font-size: var(--text-base);
      }
    }

    .checkbox-desc {
      font-size: var(--text-xs);
      color: var(--text-secondary);
      margin-left: 46px;
      line-height: var(--leading-relaxed);
    }

    @media (min-width: 768px) {
      .checkbox-desc {
        font-size: var(--text-sm);
        margin-left: 52px;
      }
    }

    /* ==================== FOOTER ==================== */
    .app-footer {
      background: var(--bg-secondary);
      margin-top: var(--space-24);
      padding: var(--space-12) var(--space-5);
      border-top: 1px solid var(--divider);
    }

    @media (min-width: 640px) {
      .app-footer {
        padding: var(--space-14) var(--space-6);
      }
    }

    @media (min-width: 768px) {
      .app-footer {
        padding: var(--space-16) var(--space-8);
        margin-top: var(--space-32);
      }
    }

    .footer-inner {
      max-width: 1280px;
      margin: var(--space-0) auto;
    }

    @media (min-width: 1024px) {
      .footer-inner {
        max-width: 1440px;
        padding: var(--space-0) var(--space-4);
      }
    }

    .footer-grid {
      display: grid;
      gap: var(--space-10);
      margin-bottom: var(--space-10);
    }

    @media (min-width: 768px) {
      .footer-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: var(--space-12);
        margin-bottom: var(--space-12);
      }
    }

    .footer-section-title {
      font-size: var(--text-xs);
      font-weight: var(--weight-semibold);
      color: var(--text-secondary);
      margin-bottom: var(--space-4);
      text-transform: uppercase;
      letter-spacing: var(--tracking-wider);
      line-height: var(--leading-tight);
    }

    @media (min-width: 768px) {
      .footer-section-title {
        font-size: var(--text-sm);
      }
    }

    .footer-desc {
      font-size: var(--text-sm);
      line-height: var(--leading-relaxed);
      color: var(--text-secondary);
      margin-bottom: var(--space-5);
    }

    @media (min-width: 768px) {
      .footer-desc {
        font-size: var(--text-base);
      }
    }

    .footer-version {
      display: inline-block;
      padding: var(--space-2) var(--space-3);
      background: var(--surface);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: var(--weight-semibold);
      color: var(--accent);
      line-height: var(--leading-none);
    }

    @media (min-width: 768px) {
      .footer-version {
        padding: var(--space-2) var(--space-4);
        font-size: var(--text-sm);
      }
    }

    .footer-links {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    @media (min-width: 768px) {
      .footer-links {
        gap: var(--space-4);
      }
    }

    .footer-link {
      color: var(--text-secondary);
      text-decoration: none;
      font-size: var(--text-sm);
      transition: color var(--duration-fast) var(--ease-out);
      line-height: var(--leading-tight);
    }

    @media (min-width: 768px) {
      .footer-link {
        font-size: var(--text-base);
      }
    }

    .footer-link:hover {
      color: var(--accent);
    }

    .footer-bottom {
      padding-top: var(--space-8);
      border-top: 1px solid var(--divider);
      text-align: center;
      font-size: var(--text-xs);
      color: var(--text-tertiary);
      line-height: var(--leading-relaxed);
    }

    @media (min-width: 768px) {
      .footer-bottom {
        font-size: var(--text-sm);
      }
    }

    /* ==================== MODALS ==================== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      z-index: var(--z-modal-backdrop);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-5);
      opacity: 0;
      transition: opacity var(--duration-slow) var(--ease-out);
      pointer-events: none;
    }

    @media (min-width: 768px) {
      .modal-overlay {
        padding: var(--space-6);
      }
    }

    .modal-overlay.show {
      opacity: 1;
      pointer-events: auto;
    }

    .modal {
      background: var(--surface);
      border-radius: var(--radius-2xl);
      padding: var(--space-6);
      max-width: 560px;
      width: 100%;
      box-shadow: var(--shadow-2xl);
      transform: scale(0.96);
      transition: transform var(--duration-slow) var(--ease-spring);
      border: 1px solid var(--divider);
    }

    @media (min-width: 640px) {
      .modal {
        padding: var(--space-8);
        border-radius: var(--radius-3xl);
      }
    }

    .modal-overlay.show .modal {
      transform: scale(1);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-6);
      gap: var(--space-4);
    }

    @media (min-width: 768px) {
      .modal-header {
        margin-bottom: var(--space-8);
      }
    }

    .modal-title {
      font-size: var(--text-xl);
      font-weight: var(--weight-semibold);
      color: var(--text);
      line-height: var(--leading-tight);
    }

    @media (min-width: 768px) {
      .modal-title {
        font-size: var(--text-2xl);
      }
    }

    .modal-close {
      appearance: none;
      border: none;
      background: transparent;
      cursor: pointer;
      padding: var(--space-2);
      color: var(--text-secondary);
      transition: all var(--duration-fast) var(--ease-out);
      border-radius: var(--radius-sm);
      flex-shrink: 0;
    }

    .modal-close:hover {
      color: var(--text);
      background: var(--bg-secondary);
    }

    .modal-body {
      margin-bottom: var(--space-6);
    }

    @media (min-width: 768px) {
      .modal-body {
        margin-bottom: var(--space-8);
      }
    }

    .modal-actions {
      display: flex;
      gap: var(--space-3);
      justify-content: flex-end;
    }

    @media (min-width: 768px) {
      .modal-actions {
        gap: var(--space-4);
      }
    }

    /* ==================== TOAST ==================== */
    .toast-container {
      position: fixed;
      top: var(--space-6);
      right: var(--space-5);
      z-index: var(--z-toast);
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
      pointer-events: none;
      max-width: calc(100vw - var(--space-10));
    }

    @media (min-width: 640px) {
      .toast-container {
        top: var(--space-8);
        right: var(--space-6);
        max-width: 400px;
      }
    }

    @media (min-width: 768px) {
      .toast-container {
        top: var(--space-10);
        right: var(--space-8);
        max-width: 420px;
      }
    }

    .toast {
      background: var(--surface-elevated);
      border-radius: var(--radius-lg);
      padding: var(--space-4) var(--space-5);
      box-shadow: var(--shadow-xl);
      display: flex;
      align-items: center;
      gap: var(--space-3);
      min-width: 280px;
      opacity: 0;
      transform: translateX(calc(100% + var(--space-8)));
      transition: all var(--duration-slow) var(--ease-out);
      pointer-events: auto;
      border: 1px solid var(--divider);
      backdrop-filter: blur(20px);
    }

    @media (min-width: 768px) {
      .toast {
        padding: var(--space-5) var(--space-6);
        gap: var(--space-4);
      }
    }

    .toast.show {
      opacity: 1;
      transform: translateX(0);
    }

    .toast-icon {
      width: 22px;
      height: 22px;
      flex-shrink: 0;
    }

    @media (min-width: 768px) {
      .toast-icon {
        width: 24px;
        height: 24px;
      }
    }

    .toast-message {
      flex: 1;
      font-size: var(--text-sm);
      color: var(--text);
      line-height: var(--leading-tight);
    }

    @media (min-width: 768px) {
      .toast-message {
        font-size: var(--text-base);
      }
    }

    .toast.success {
      border-left: 3px solid var(--success);
    }

    .toast.error {
      border-left: 3px solid var(--danger);
    }

    .toast.warning {
      border-left: 3px solid var(--warning);
    }

    /* ==================== LOADING ==================== */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2.5px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ==================== ANIMATIONS ==================== */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(var(--space-8));
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(calc(-1 * var(--space-8)));
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .fade-in {
      animation: fadeIn var(--duration-slower) var(--ease-out);
    }

    .slide-in {
      animation: slideIn var(--duration-slow) var(--ease-out);
    }

    /* Stagger animation */
    .cards-grid .card:nth-child(1) { animation-delay: 0ms; }
    .cards-grid .card:nth-child(2) { animation-delay: 60ms; }
    .cards-grid .card:nth-child(3) { animation-delay: 120ms; }
    .cards-grid .card:nth-child(4) { animation-delay: 180ms; }
    .cards-grid .card:nth-child(5) { animation-delay: 240ms; }
    .cards-grid .card:nth-child(6) { animation-delay: 300ms; }
    .cards-grid .card:nth-child(7) { animation-delay: 360ms; }
    .cards-grid .card:nth-child(8) { animation-delay: 420ms; }
    .cards-grid .card:nth-child(9) { animation-delay: 480ms; }
    .cards-grid .card:nth-child(10) { animation-delay: 540ms; }

    /* ==================== SCROLLBAR ==================== */
    ::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--divider);
      border-radius: 6px;
      border: 3px solid var(--bg);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-tertiary);
    }

    * {
      scrollbar-width: thin;
      scrollbar-color: var(--divider) transparent;
    }

    /* ==================== SELECTION ==================== */
    ::selection {
      background: var(--accent-light);
      color: var(--text);
    }

    /* ==================== FOCUS ==================== */
    :focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 4px;
      border-radius: var(--radius-xs);
    }

    button:focus-visible,
    .btn:focus-visible {
      outline-offset: 4px;
    }

    /* ==================== UTILITIES ==================== */
    .hidden {
      display: none !important;
    }

    /* ==================== PRINT ==================== */
    @media print {
      .app-header,
      .hero,
      .tabs,
      .btn-group,
      .app-footer,
      .toast-container {
        display: none;
      }
      
      body {
        background: white;
        color: black;
      }
      
      .panel {
        box-shadow: none;
        border: 1px solid #ddd;
        page-break-inside: avoid;
      }
      
      .card {
        break-inside: avoid;
        page-break-inside: avoid;
      }
    }

    /* ==================== REDUCED MOTION ==================== */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="header-inner">
      <div class="title">
        <h1>塔羅</h1>
      </div>
      <div class="header-actions">
        <button id="themeToggle" class="icon-btn" aria-label="切換主題" title="切換主題 (T)">
          <svg class="icon" id="iconSun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="display:none"><path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.106a.75.75 0 010 1.06l-1.591 1.59a.75.75 0 11-1.06-1.06l1.59-1.59a.75.75 0 011.061 0zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.803 17.803a.75.75 0 01-1.06 0l-1.59-1.591a.75.75 0 111.06-1.06l1.59 1.59a.75.75 0 010 1.06zM12 18.75a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0v-2.25a.75.75 0 01.75-.75zM5.197 17.803a.75.75 0 010-1.06l1.59-1.59a.75.75 0 111.06 1.06l-1.59 1.59a.75.75 0 01-1.06 0zM3 12a.75.75 0 01.75-.75h2.25a.75.75 0 010 1.5H3.75A.75.75 0 013 12z"/></svg>
          <svg class="icon" id="iconMoon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 003.463-.69.75.75 0 01.981.98 10.503 10.503 0 01-9.694 6.46c-5.799 0-10.5-4.701-10.5-10.5 0-3.864 2.11-7.25 5.282-9.022a.75.75 0 01.819.162z" clip-rule="evenodd"/></svg>
        </button>
      </div>
    </div>
  </header>

  <section class="hero">
    <h2 class="hero-title">探索內心的指引</h2>
    <p class="hero-subtitle">簡潔直覺的占卜體驗，專注於當下的洞察</p>
  </section>

  <div class="container">
    <div class="tabs" role="tablist" id="tabsContainer">
      <button class="tab active" data-tab="reading" role="tab" aria-selected="true">占卜</button>
      <button class="tab" data-tab="history" role="tab">記錄</button>
      <button class="tab" data-tab="statistics" role="tab">統計</button>
      <button class="tab" data-tab="database" role="tab">資料庫</button>
      <button class="tab" data-tab="settings" role="tab">設定</button>
    </div>

    <!-- Tab: Reading -->
    <div id="tabReading" class="tab-content">
      <div class="panel">
        <div class="form-section">
          <div class="form-grid">
            <div class="form-field full">
              <label for="question">你的問題</label>
              <input id="question" type="text" placeholder="例如：目前最需要專注的方向？" />
            </div>
            <div class="form-field">
              <label for="deckType">牌組</label>
              <select id="deckType">
                <option value="full">完整牌組 (78張)</option>
                <option value="major">大阿卡納 (22張)</option>
                <option value="minor">小阿卡納 (56張)</option>
                <option value="court">宮廷牌 (16張)</option>
                <option value="numbered">數字牌 (40張)</option>
              </select>
            </div>
            <div class="form-field">
              <label for="spreadType">牌陣</label>
              <select id="spreadType">
                <option value="single" data-spread-name="單張牌指引">單張牌</option>
                <option value="three" data-spread-name="聖三角">聖三角</option>
                <option value="mbs" data-spread-name="身心靈牌陣">身心靈</option>
                <option value="path" data-spread-name="抉擇之路">抉擇之路</option>
                <option value="twoChoice" data-spread-name="二擇一">二擇一</option>
                <option value="prosCons" data-spread-name="優劣分析">優劣分析</option>
                <option value="goal" data-spread-name="目標達成牌陣">目標達成</option>
                <option value="relationship" data-spread-name="關係牌陣">關係牌陣</option>
                <option value="weekly" data-spread-name="週運勢">週運勢</option>
                <option value="monthly" data-spread-name="月運勢">月運勢</option>
                <option value="quarterly" data-spread-name="季度展望">季度展望</option>
                <option value="yearly" data-spread-name="年度主題">年度主題</option>
                <option value="chakra" data-spread-name="脈輪牌陣">脈輪牌陣</option>
                <option value="elements" data-spread-name="四元素牌陣">四元素</option>
                <option value="celtic" data-spread-name="凱爾特十字">凱爾特十字</option>
              </select>
            </div>
          </div>

          <div class="btn-group">
            <button id="readButton" class="btn btn-primary">
              <span id="readButtonText">開始占卜</span>
            </button>
            <button id="shareButton" class="btn btn-secondary">分享</button>
          </div>
        </div>

        <div id="spreadInfo" class="spread-info hidden">
          <div class="spread-info-title">
            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm8.706-1.442c1.146-.573 2.437.463 2.126 1.706l-.709 2.836.042-.02a.75.75 0 01.67 1.34l-.04.022c-1.147.573-2.438-.463-2.127-1.706l.71-2.836-.042.02a.75.75 0 11-.671-1.34l.041-.022zM12 9a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd"/></svg>
            關於此牌陣
          </div>
          <div class="spread-info-content" id="spreadInfoContent"></div>
          <div class="spread-positions-title">牌位說明</div>
          <div class="spread-positions-list" id="spreadPositionsList"></div>
        </div>
      </div>

      <div id="results" class="results"></div>
    </div>

    <!-- Tab: History -->
    <div id="tabHistory" class="tab-content hidden">
      <div class="panel">
        <div class="results-header">
          <h2 class="results-title">占卜記錄</h2>
        </div>
        
        <div class="history-controls">
          <select id="filterSpread" class="btn btn-tertiary btn-sm">
            <option value="">所有牌陣</option>
          </select>
          <select id="filterTag" class="btn btn-tertiary btn-sm">
            <option value="">所有標籤</option>
          </select>
          <button id="filterFavorite" class="btn btn-tertiary btn-sm">⭐ 收藏</button>
          <div style="flex: 1"></div>
          <button id="clearHistory" class="btn btn-tertiary btn-sm">清除記錄</button>
        </div>

        <div id="historyList" class="history-list"></div>
      </div>
    </div>

    <!-- Tab: Statistics -->
    <div id="tabStatistics" class="tab-content hidden">
      <div class="panel">
        <div class="results-header">
          <h2 class="results-title">統計分析</h2>
        </div>
        <div id="statisticsContent" class="stats-grid"></div>
      </div>
    </div>

    <!-- Tab: Database -->
    <div id="tabDatabase" class="tab-content hidden">
      <div class="panel">
        <div class="results-header">
          <h2 class="results-title">牌卡資料庫</h2>
        </div>
        <div class="search-field">
          <input type="text" id="cardSearch" placeholder="搜尋牌名或英文名..." />
        </div>
        <div id="cardDatabaseGrid" class="card-db-grid"></div>
      </div>
    </div>

    <!-- Tab: Settings -->
    <div id="tabSettings" class="tab-content hidden">
      <div class="panel">
        <div class="results-header">
          <h2 class="results-title">設定</h2>
        </div>
        
        <div class="settings-section">
          <div class="settings-title">視覺樣式</div>
          <div class="checkbox-group">
            <label class="checkbox-item">
              <input type="radio" name="visualStyle" value="text" checked />
              <span class="checkbox-label">純文字模式（預設）</span>
            </label>
            <div class="checkbox-desc">簡潔的文字呈現，快速載入</div>
            
            <label class="checkbox-item">
              <input type="radio" name="visualStyle" value="css" />
              <span class="checkbox-label">CSS 漸層卡牌</span>
            </label>
            <div class="checkbox-desc">美麗的漸層背景與大型數字</div>
            
            <label class="checkbox-item">
              <input type="radio" name="visualStyle" value="emoji" />
              <span class="checkbox-label">Emoji 符號模式</span>
            </label>
            <div class="checkbox-desc">可愛的 Emoji 圖標裝飾</div>
            
            <label class="checkbox-item">
              <input type="radio" name="visualStyle" value="api" />
              <span class="checkbox-label">API 圖片模式</span>
            </label>
            <div class="checkbox-desc">從 Tarot API 載入真實牌卡圖片（需網路）</div>
          </div>
        </div>

        <div class="settings-section">
          <div class="settings-title">顯示偏好</div>
          <div class="checkbox-group">
            <label class="checkbox-item">
              <input type="checkbox" id="showSpreadInfo" checked />
              <span class="checkbox-label">顯示牌陣說明</span>
            </label>
            <div class="checkbox-desc">在占卜時顯示牌陣的詳細說明</div>
            
            <label class="checkbox-item">
              <input type="checkbox" id="showShortcuts" checked />
              <span class="checkbox-label">啟用鍵盤快捷鍵</span>
            </label>
            <div class="checkbox-desc">使用鍵盤快速操作</div>
          </div>
        </div>

        <div class="settings-section">
          <div class="settings-title">資料管理</div>
          <div class="btn-group">
            <button id="exportData" class="btn btn-tertiary">匯出資料</button>
            <button id="importData" class="btn btn-tertiary">匯入資料</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="app-footer">
    <div class="footer-inner">
      <div class="footer-grid">
        <div>
          <h3 class="footer-section-title">關於</h3>
          <p class="footer-desc">
            純粹的占卜工具，專注於呈現牌卡結果。所有資料僅存於您的裝置，完全私密。
          </p>
          <span class="footer-version">v5.1.0</span>
        </div>
        
        <div>
          <h3 class="footer-section-title">連結</h3>
          <div class="footer-links">
            <a href="#" class="footer-link">使用說明</a>
            <a href="#" class="footer-link">隱私政策</a>
            <a href="#" class="footer-link">常見問題</a>
          </div>
        </div>

        <div>
          <h3 class="footer-section-title">聯絡</h3>
          <div class="footer-links">
            <a href="#" class="footer-link" id="linkAbout">關於本站</a>
            <a href="#" class="footer-link" id="linkPrivacy">隱私條款</a>
          </div>
        </div>
      </div>

      <div class="footer-bottom">
        © 2025 塔羅占卜工具 · 僅供參考使用
      </div>
    </div>
  </footer>

  <div id="toastContainer" class="toast-container"></div>

  <!-- Modal: Add Note -->
  <div id="noteModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">新增筆記</h3>
        <button class="modal-close" onclick="closeNoteModal()">
          <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6.225 4.811a1 1 0 00-1.414 1.414L10.586 12 4.81 17.775a1 1 0 101.414 1.414L12 13.414l5.775 5.775a1 1 0 001.414-1.414L13.414 12l5.775-5.775a1 1 0 00-1.414-1.414L12 10.586 6.225 4.81z"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <textarea id="noteText" placeholder="寫下你的感受與想法..."></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn btn-tertiary btn-sm" onclick="closeNoteModal()">取消</button>
        <button class="btn btn-primary btn-sm" onclick="saveNote()">儲存</button>
      </div>
    </div>
  </div>

  <!-- Modal: Add Tags -->
  <div id="tagModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">新增標籤</h3>
        <button class="modal-close" onclick="closeTagModal()">
          <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6.225 4.811a1 1 0 00-1.414 1.414L10.586 12 4.81 17.775a1 1 0 101.414 1.414L12 13.414l5.775 5.775a1 1 0 001.414-1.414L13.414 12l5.775-5.775a1 1 0 00-1.414-1.414L12 10.586 6.225 4.81z"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-field">
          <label>常用標籤</label>
          <div class="tags" id="commonTags"></div>
        </div>
        <div class="form-field">
          <label>自訂標籤</label>
          <input type="text" id="customTag" placeholder="輸入標籤名稱..." />
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-tertiary btn-sm" onclick="closeTagModal()">取消</button>
        <button class="btn btn-primary btn-sm" onclick="saveTag()">新增</button>
      </div>
    </div>
  </div>

<script>
    // ==================== UTILITIES ====================
    function escapeHTML(str) {
      return String(str).replace(/[&<>"']/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[s]));
    }

    function mulberry32(a) {
      return function () {
        let t = a += 0x6D2B79F5;
        t = Math.imul(t ^ t >>> 15, t | 1);
        t ^= t + Math.imul(t ^ t >>> 7, t | 61);
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      };
    }

    function shuffle(arr, rng = Math.random) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(rng() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function getSeed() {
      const url = new URL(location.href);
      const s = url.searchParams.get('seed');
      return s ? Number(s) : Math.floor(Math.random() * 1e9);
    }

    function updateURL(params) {
      const url = new URL(location.href);
      Object.entries(params).forEach(([k, v]) => {
        if (v === undefined || v === null || v === '') url.searchParams.delete(k);
        else url.searchParams.set(k, String(v));
      });
      history.replaceState(null, '', url.toString());
    }

    function formatDate(timestamp) {
      const d = new Date(timestamp);
      return `${d.getFullYear()}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icon = type === 'success' ? 
        '<svg class="toast-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm13.36-1.814a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clip-rule="evenodd"/></svg>' :
        type === 'error' ?
        '<svg class="toast-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm-1.72 6.97a.75.75 0 10-1.06 1.06L10.94 12l-1.72 1.72a.75.75 0 101.06 1.06L12 13.06l1.72 1.72a.75.75 0 101.06-1.06L13.06 12l1.72-1.72a.75.75 0 10-1.06-1.06L12 10.94l-1.72-1.72z" clip-rule="evenodd"/></svg>' :
        '<svg class="toast-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M9.401 3.003c1.155-2 4.043-2 5.197 0l7.355 12.748c1.154 2-.29 4.5-2.599 4.5H4.645c-2.309 0-3.752-2.5-2.598-4.5L9.4 3.003zM12 8.25a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75zm0 8.25a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd"/></svg>';
      
      toast.innerHTML = `
        ${icon}
        <span class="toast-message">${escapeHTML(message)}</span>
      `;
      
      container.appendChild(toast);
      
      requestAnimationFrame(() => {
        toast.classList.add('show');
      });
      
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 500);
      }, 3000);
    }

    // ==================== CARD VISUAL DATA ====================
    const cardEmojis = {
      // Major Arcana
      '愚者': '🌟', '魔術師': '🎩', '女祭司': '🌙', '皇后': '👑', '皇帝': '⚜️',
      '教皇': '📿', '戀人': '💕', '戰車': '🏇', '力量': '🦁', '隱士': '🕯️',
      '命運之輪': '🎡', '正義': '⚖️', '倒吊人': '🔄', '死神': '💀', '節制': '🍷',
      '惡魔': '😈', '高塔': '🗼', '星星': '⭐', '月亮': '🌜', '太陽': '☀️',
      '審判': '📯', '世界': '🌍',
      // Wands
      '權杖一': '🔥', '權杖二': '⚡', '權杖三': '🕯️', '權杖四': '🏆',
      '權杖五': '⚔️', '權杖六': '🎖️', '權杖七': '🛡️', '權杖八': '🏹',
      '權杖九': '🔱', '權杖十': '⚜️', '權杖侍者': '🎯', '權杖騎士': '🐎',
      '權杖皇后': '👸', '權杖國王': '🤴',
      // Cups
      '聖杯一': '💧', '聖杯二': '🌊', '聖杯三': '🍷', '聖杯四': '💙',
      '聖杯五': '💔', '聖杯六': '🌸', '聖杯七': '🌈', '聖杯八': '🌙',
      '聖杯九': '✨', '聖杯十': '💖', '聖杯侍者': '🧜', '聖杯騎士': '🦄',
      '聖杯皇后': '👑', '聖杯國王': '🔱',
      // Swords
      '寶劍一': '⚔️', '寶劍二': '🗡️', '寶劍三': '💔', '寶劍四': '😴',
      '寶劍五': '⚡', '寶劍六': '⛵', '寶劍七': '🎭', '寶劍八': '🔗',
      '寶劍九': '😰', '寶劍十': '💀', '寶劍侍者': '🗡️', '寶劍騎士': '🏇',
      '寶劍皇后': '👸', '寶劍國王': '🤴',
      // Pentacles
      '錢幣一': '💰', '錢幣二': '⚖️', '錢幣三': '🔨', '錢幣四': '🏰',
      '錢幣五': '🍂', '錢幣六': '⚖️', '錢幣七': '🌱', '錢幣八': '🛠️',
      '錢幣九': '🌳', '錢幣十': '🏡', '錢幣侍者': '📚', '錢幣騎士': '🐢',
      '錢幣皇后': '👑', '錢幣國王': '👑'
    };

    const suitGradients = {
      'Major Arcana': { start: '#9b59b6', end: '#e67e22' },
      'Wands': { start: '#e74c3c', end: '#f39c12' },
      'Cups': { start: '#3498db', end: '#16a085' },
      'Swords': { start: '#7f8c8d', end: '#3498db' },
      'Pentacles': { start: '#f39c12', end: '#27ae60' }
    };

    // ==================== DATA ====================
    const fullTarotCards = [
      { name: "愚者", suit: "Major Arcana", number: "0", englishName: "The Fool", nameKey: "fool" }, 
      { name: "魔術師", suit: "Major Arcana", number: "I", englishName: "The Magician", nameKey: "magician" }, 
      { name: "女祭司", suit: "Major Arcana", number: "II", englishName: "The High Priestess", nameKey: "high_priestess" }, 
      { name: "皇后", suit: "Major Arcana", number: "III", englishName: "The Empress", nameKey: "empress" }, 
      { name: "皇帝", suit: "Major Arcana", number: "IV", englishName: "The Emperor", nameKey: "emperor" }, 
      { name: "教皇", suit: "Major Arcana", number: "V", englishName: "The Hierophant", nameKey: "hierophant" }, 
      { name: "戀人", suit: "Major Arcana", number: "VI", englishName: "The Lovers", nameKey: "lovers" }, 
      { name: "戰車", suit: "Major Arcana", number: "VII", englishName: "The Chariot", nameKey: "chariot" }, 
      { name: "力量", suit: "Major Arcana", number: "VIII", englishName: "Strength", nameKey: "strength" }, 
      { name: "隱士", suit: "Major Arcana", number: "IX", englishName: "The Hermit", nameKey: "hermit" }, 
      { name: "命運之輪", suit: "Major Arcana", number: "X", englishName: "Wheel of Fortune", nameKey: "wheel_of_fortune" }, 
      { name: "正義", suit: "Major Arcana", number: "XI", englishName: "Justice", nameKey: "justice" }, 
      { name: "倒吊人", suit: "Major Arcana", number: "XII", englishName: "The Hanged Man", nameKey: "hanged_man" }, 
      { name: "死神", suit: "Major Arcana", number: "XIII", englishName: "Death", nameKey: "death" }, 
      { name: "節制", suit: "Major Arcana", number: "XIV", englishName: "Temperance", nameKey: "temperance" }, 
      { name: "惡魔", suit: "Major Arcana", number: "XV", englishName: "The Devil", nameKey: "devil" }, 
      { name: "高塔", suit: "Major Arcana", number: "XVI", englishName: "The Tower", nameKey: "tower" }, 
      { name: "星星", suit: "Major Arcana", number: "XVII", englishName: "The Star", nameKey: "star" }, 
      { name: "月亮", suit: "Major Arcana", number: "XVIII", englishName: "The Moon", nameKey: "moon" }, 
      { name: "太陽", suit: "Major Arcana", number: "XIX", englishName: "The Sun", nameKey: "sun" }, 
      { name: "審判", suit: "Major Arcana", number: "XX", englishName: "Judgement", nameKey: "judgement" }, 
      { name: "世界", suit: "Major Arcana", number: "XXI", englishName: "The World", nameKey: "world" },
      { name: "權杖一", suit: "Wands", number: "Ace", englishName: "Ace of Wands", nameKey: "ace_of_wands" }, 
      { name: "權杖二", suit: "Wands", number: "Two", englishName: "Two of Wands", nameKey: "two_of_wands" }, 
      { name: "權杖三", suit: "Wands", number: "Three", englishName: "Three of Wands", nameKey: "three_of_wands" }, 
      { name: "權杖四", suit: "Wands", number: "Four", englishName: "Four of Wands", nameKey: "four_of_wands" }, 
      { name: "權杖五", suit: "Wands", number: "Five", englishName: "Five of Wands", nameKey: "five_of_wands" }, 
      { name: "權杖六", suit: "Wands", number: "Six", englishName: "Six of Wands", nameKey: "six_of_wands" }, 
      { name: "權杖七", suit: "Wands", number: "Seven", englishName: "Seven of Wands", nameKey: "seven_of_wands" }, 
      { name: "權杖八", suit: "Wands", number: "Eight", englishName: "Eight of Wands", nameKey: "eight_of_wands" }, 
      { name: "權杖九", suit: "Wands", number: "Nine", englishName: "Nine of Wands", nameKey: "nine_of_wands" }, 
      { name: "權杖十", suit: "Wands", number: "Ten", englishName: "Ten of Wands", nameKey: "ten_of_wands" }, 
      { name: "權杖侍者", suit: "Wands", number: "Page", englishName: "Page of Wands", nameKey: "page_of_wands" }, 
      { name: "權杖騎士", suit: "Wands", number: "Knight", englishName: "Knight of Wands", nameKey: "knight_of_wands" }, 
      { name: "權杖皇后", suit: "Wands", number: "Queen", englishName: "Queen of Wands", nameKey: "queen_of_wands" }, 
      { name: "權杖國王", suit: "Wands", number: "King", englishName: "King of Wands", nameKey: "king_of_wands" },
      { name: "聖杯一", suit: "Cups", number: "Ace", englishName: "Ace of Cups", nameKey: "ace_of_cups" }, 
      { name: "聖杯二", suit: "Cups", number: "Two", englishName: "Two of Cups", nameKey: "two_of_cups" }, 
      { name: "聖杯三", suit: "Cups", number: "Three", englishName: "Three of Cups", nameKey: "three_of_cups" }, 
      { name: "聖杯四", suit: "Cups", number: "Four", englishName: "Four of Cups", nameKey: "four_of_cups" }, 
      { name: "聖杯五", suit: "Cups", number: "Five", englishName: "Five of Cups", nameKey: "five_of_cups" }, 
      { name: "聖杯六", suit: "Cups", number: "Six", englishName: "Six of Cups", nameKey: "six_of_cups" }, 
      { name: "聖杯七", suit: "Cups", number: "Seven", englishName: "Seven of Cups", nameKey: "seven_of_cups" }, 
      { name: "聖杯八", suit: "Cups", number: "Eight", englishName: "Eight of Cups", nameKey: "eight_of_cups" }, 
      { name: "聖杯九", suit: "Cups", number: "Nine", englishName: "Nine of Cups", nameKey: "nine_of_cups" }, 
      { name: "聖杯十", suit: "Cups", number: "Ten", englishName: "Ten of Cups", nameKey: "ten_of_cups" }, 
      { name: "聖杯侍者", suit: "Cups", number: "Page", englishName: "Page of Cups", nameKey: "page_of_cups" }, 
      { name: "聖杯騎士", suit: "Cups", number: "Knight", englishName: "Knight of Cups", nameKey: "knight_of_cups" }, 
      { name: "聖杯皇后", suit: "Cups", number: "Queen", englishName: "Queen of Cups", nameKey: "queen_of_cups" }, 
      { name: "聖杯國王", suit: "Cups", number: "King", englishName: "King of Cups", nameKey: "king_of_cups" },
      { name: "寶劍一", suit: "Swords", number: "Ace", englishName: "Ace of Swords", nameKey: "ace_of_swords" }, 
      { name: "寶劍二", suit: "Swords", number: "Two", englishName: "Two of Swords", nameKey: "two_of_swords" }, 
      { name: "寶劍三", suit: "Swords", number: "Three", englishName: "Three of Swords", nameKey: "three_of_swords" }, 
      { name: "寶劍四", suit: "Swords", number: "Four", englishName: "Four of Swords", nameKey: "four_of_swords" }, 
      { name: "寶劍五", suit: "Swords", number: "Five", englishName: "Five of Swords", nameKey: "five_of_swords" }, 
      { name: "寶劍六", suit: "Swords", number: "Six", englishName: "Six of Swords", nameKey: "six_of_swords" }, 
      { name: "寶劍七", suit: "Swords", number: "Seven", englishName: "Seven of Swords", nameKey: "seven_of_swords" }, 
      { name: "寶劍八", suit: "Swords", number: "Eight", englishName: "Eight of Swords", nameKey: "eight_of_swords" }, 
      { name: "寶劍九", suit: "Swords", number: "Nine", englishName: "Nine of Swords", nameKey: "nine_of_swords" }, 
      { name: "寶劍十", suit: "Swords", number: "Ten", englishName: "Ten of Swords", nameKey: "ten_of_swords" }, 
      { name: "寶劍侍者", suit: "Swords", number: "Page", englishName: "Page of Swords", nameKey: "page_of_swords" }, 
      { name: "寶劍騎士", suit: "Swords", number: "Knight", englishName: "Knight of Swords", nameKey: "knight_of_swords" }, 
      { name: "寶劍皇后", suit: "Swords", number: "Queen", englishName: "Queen of Swords", nameKey: "queen_of_swords" }, 
      { name: "寶劍國王", suit: "Swords", number: "King", englishName: "King of Swords", nameKey: "king_of_swords" },
      { name: "錢幣一", suit: "Pentacles", number: "Ace", englishName: "Ace of Pentacles", nameKey: "ace_of_pentacles" }, 
      { name: "錢幣二", suit: "Pentacles", number: "Two", englishName: "Two of Pentacles", nameKey: "two_of_pentacles" }, 
      { name: "錢幣三", suit: "Pentacles", number: "Three", englishName: "Three of Pentacles", nameKey: "three_of_pentacles" }, 
      { name: "錢幣四", suit: "Pentacles", number: "Four", englishName: "Four of Pentacles", nameKey: "four_of_pentacles" }, 
      { name: "錢幣五", suit: "Pentacles", number: "Five", englishName: "Five of Pentacles", nameKey: "five_of_pentacles" }, 
      { name: "錢幣六", suit: "Pentacles", number: "Six", englishName: "Six of Pentacles", nameKey: "six_of_pentacles" }, 
      { name: "錢幣七", suit: "Pentacles", number: "Seven", englishName: "Seven of Pentacles", nameKey: "seven_of_pentacles" }, 
      { name: "錢幣八", suit: "Pentacles", number: "Eight", englishName: "Eight of Pentacles", nameKey: "eight_of_pentacles" }, 
      { name: "錢幣九", suit: "Pentacles", number: "Nine", englishName: "Nine of Pentacles", nameKey: "nine_of_pentacles" }, 
      { name: "錢幣十", suit: "Pentacles", number: "Ten", englishName: "Ten of Pentacles", nameKey: "ten_of_pentacles" }, 
      { name: "錢幣侍者", suit: "Pentacles", number: "Page", englishName: "Page of Pentacles", nameKey: "page_of_pentacles" }, 
      { name: "錢幣騎士", suit: "Pentacles", number: "Knight", englishName: "Knight of Pentacles", nameKey: "knight_of_pentacles" }, 
      { name: "錢幣皇后", suit: "Pentacles", number: "Queen", englishName: "Queen of Pentacles", nameKey: "queen_of_pentacles" }, 
      { name: "錢幣國王", suit: "Pentacles", number: "King", englishName: "King of Pentacles", nameKey: "king_of_pentacles" }
    ];

    const majorArcana = fullTarotCards.slice(0, 22);
    const minorArcana = fullTarotCards.slice(22);
    const courtCards = fullTarotCards.filter(c => ['Page', 'Knight', 'Queen', 'King'].includes(c.number));
    const numberedCards = fullTarotCards.filter(c => !['Page', 'Knight', 'Queen', 'King'].includes(c.number) && c.suit !== 'Major Arcana');

    const spreads = {
      single: { positions: ['核心指引'], description: '最簡單直接的牌陣，適合日常指引或快速問答。' },
      three: { positions: ['過去', '現在', '未來'], description: '經典三張牌時間線，呈現事件發展脈絡。' },
      mbs: { positions: ['心態', '身體', '靈性'], description: '身心靈整體檢視，觀察平衡狀態。' },
      path: { positions: ['問題', '挑戰', '方向', '結果'], description: '四步驟路徑牌陣，釐清完整流程。' },
      twoChoice: { positions: ['現況', '選項A過程', '選項B過程', '選項A結果', '選項B結果'], description: '比較兩個選擇的過程與結果。' },
      prosCons: { positions: ['選項A優點', '選項A缺點', '選項B優點', '選項B缺點', '核心提示'], description: '優劣分析，客觀呈現正反面。' },
      goal: { positions: ['核心', '阻礙', '資源', '步驟', '結果'], description: '目標達成的五個關鍵面向。' },
      relationship: { positions: ['你的觀點', '對方觀點', '現況', '挑戰', '潛力'], description: '關係探索，呈現雙方視角。' },
      weekly: { positions: ['主題', '週一', '週二', '週三', '週四', '週五', '週六', '週日'], description: '週運勢，含整週基調與每日提示。' },
      monthly: { positions: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'], description: '全年十二個月的能量主題。' },
      quarterly: { positions: ['春季', '夏季', '秋季', '冬季'], description: '以四季觀察全年能量流動。' },
      yearly: { positions: ['總主題', '一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'], description: '年度主題加各月重點。' },
      chakra: { positions: ['海底輪', '臍輪', '太陽神經叢', '心輪', '喉輪', '眉心輪', '頂輪'], description: '七脈輪能量檢視。' },
      elements: { positions: ['火', '水', '風', '土', '靈'], description: '五元素平衡狀態。' },
      celtic: { positions: ['核心', '阻礙', '根基', '過去', '目標', '未來', '態度', '環境', '希望', '結果'], description: '經典凱爾特十字，深入探索。' }
    };

    const commonTags = ['工作', '感情', '健康', '財運', '學業', '人際', '靈性', '決策'];

    // ==================== STATE ====================
    let lastReadingData = {};
    let readingHistory = JSON.parse(localStorage.getItem('readingHistory') || '[]');
    let currentTab = 'reading';
    let currentEditingId = null;
    let visualStyle = localStorage.getItem('visualStyle') || 'text';

    // ==================== VISUAL STYLE ====================
    function setVisualStyle(style) {
      visualStyle = style;
      localStorage.setItem('visualStyle', style);
      document.querySelectorAll('input[name="visualStyle"]').forEach(radio => {
        radio.checked = radio.value === style;
      });
      if (lastReadingData.drawnCards) {
        renderResults(lastReadingData);
      }
    }

    document.querySelectorAll('input[name="visualStyle"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        if (e.target.checked) {
          setVisualStyle(e.target.value);
          showToast(`已切換至${e.target.nextElementSibling.textContent}`);
        }
      });
    });

// ==================== CARD RENDERING ====================
function renderCard(card, isBottom = false) {
  const gradient = suitGradients[card.suit];
  const emoji = cardEmojis[card.name] || '🎴';
  
  let cardHTML = '';
  let visualClass = '';
  
  if (visualStyle === 'text') {
    visualClass = '';
  } else if (visualStyle === 'css') {
    visualClass = 'visual-css';
  } else if (visualStyle === 'emoji') {
    visualClass = 'visual-emoji';
  } else if (visualStyle === 'api') {
    visualClass = 'visual-api';
  }
  
  // 修正：構建正確的 API URL
  let apiImageUrl = '';
  if (visualStyle === 'api') {
    // 使用正確的 API 端點
    apiImageUrl = `https://tarot-api-3hv5.onrender.com/api/v1/cards/${card.nameKey}`;
    // 備用方案：如果主 API 失敗，使用另一個 Tarot API
    // apiImageUrl = `https://tarotapi.dev/api/v1/cards/${card.nameKey}`;
  }
  
  cardHTML = `
    <div class="card ${isBottom ? 'bottom' : ''} ${visualClass} slide-in" 
         style="${visualStyle === 'css' ? `--card-gradient-start: ${gradient.start}; --card-gradient-end: ${gradient.end};` : ''}"
         tabindex="0">
      ${visualStyle === 'api' ? `
        <div class="card-image-container">
          <div class="card-image-loading">載入中...</div>
          <img class="card-image" 
               src="${apiImageUrl}" 
               alt="${card.name}"
               loading="lazy"
               style="display: none;"
               onload="this.style.display='block'; this.previousElementSibling.style.display='none';"
               onerror="handleImageError(this, '${escapeHTML(card.name)}', '${emoji}')"/>
        </div>
        <div class="card-info">
      ` : ''}
      
      <div class="card-position">${escapeHTML(card.position)}</div>
      
      ${visualStyle === 'css' ? `
        <div class="card-visual-number">${escapeHTML(card.number)}</div>
        <div class="card-visual-emoji">${emoji}</div>
      ` : ''}
      
      ${visualStyle === 'emoji' ? `
        <div class="card-emoji-large">${emoji}</div>
      ` : ''}
      
      <div class="card-content">
        <div class="card-name">${escapeHTML(card.name)}</div>
        <div class="card-orientation">
          <span class="ori-icon ${card.orientation === '逆位' ? 'reversed' : ''}"></span>
          ${escapeHTML(card.orientation)}
        </div>
      </div>
      <div class="card-footer">
        <span>${escapeHTML(card.number)}</span>
        <span>${escapeHTML(card.englishName)}</span>
      </div>
      
      ${visualStyle === 'api' ? '</div>' : ''}
    </div>
  `;
  
  return cardHTML;
}

// 新增：圖片載入錯誤處理函數
function handleImageError(img, cardName, emoji) {
  const container = img.parentElement;
  container.innerHTML = `
    <div style="
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--bg-secondary);
      gap: var(--space-4);
      padding: var(--space-6);
    ">
      <div style="font-size: 64px;">${emoji}</div>
      <div style="font-size: var(--text-sm); color: var(--text-secondary); text-align: center;">
        圖片載入失敗<br/>
        <span style="font-size: var(--text-xs);">${cardName}</span>
      </div>
    </div>
  `;
}

    // ==================== ELEMENTS ====================
    const resultsEl = document.getElementById('results');
    const readBtn = document.getElementById('readButton');
    const readBtnText = document.getElementById('readButtonText');
    const shareBtn = document.getElementById('shareButton');
    const themeToggle = document.getElementById('themeToggle');
    const iconSun = document.getElementById('iconSun');
    const iconMoon = document.getElementById('iconMoon');
    const spreadTypeEl = document.getElementById('spreadType');
    const spreadInfoEl = document.getElementById('spreadInfo');
    const showSpreadInfoCheckbox = document.getElementById('showSpreadInfo');
    const showShortcutsCheckbox = document.getElementById('showShortcuts');

    // ==================== THEME ====================
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') {
      document.documentElement.classList.add('light');
      iconSun.style.display = 'none';
      iconMoon.style.display = 'block';
    }
    if (savedTheme === 'dark') {
      document.documentElement.classList.add('dark');
      iconSun.style.display = 'block';
      iconMoon.style.display = 'none';
    }

    themeToggle.addEventListener('click', toggleTheme);

    function toggleTheme() {
      const root = document.documentElement;
      const isDark = root.classList.contains('dark');
      const isLight = root.classList.contains('light');
      if (isDark) {
        root.classList.remove('dark');
        root.classList.add('light');
        localStorage.setItem('theme', 'light');
        iconSun.style.display = 'none';
        iconMoon.style.display = 'block';
      } else if (isLight) {
        root.classList.remove('light');
        root.classList.add('dark');
        localStorage.setItem('theme', 'dark');
        iconSun.style.display = 'block';
        iconMoon.style.display = 'none';
      } else {
        root.classList.add('dark');
        localStorage.setItem('theme', 'dark');
        iconSun.style.display = 'block';
        iconMoon.style.display = 'none';
      }
    }

    // ==================== KEYBOARD SHORTCUTS ====================
    let shortcutsEnabled = localStorage.getItem('showShortcuts') !== 'false';
    if (showShortcutsCheckbox) {
      showShortcutsCheckbox.checked = shortcutsEnabled;
      showShortcutsCheckbox.addEventListener('change', (e) => {
        shortcutsEnabled = e.target.checked;
        localStorage.setItem('showShortcuts', shortcutsEnabled);
      });
    }

    document.addEventListener('keydown', (e) => {
      if (!shortcutsEnabled) return;
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;

      switch(e.key.toLowerCase()) {
        case ' ':
          e.preventDefault();
          if (currentTab === 'reading' && !readBtn.disabled) performReading();
          break;
        case 't':
          e.preventDefault();
          toggleTheme();
          break;
        case '1': e.preventDefault(); switchTab('reading'); break;
        case '2': e.preventDefault(); switchTab('history'); break;
        case '3': e.preventDefault(); switchTab('statistics'); break;
        case '4': e.preventDefault(); switchTab('database'); break;
        case '5': e.preventDefault(); switchTab('settings'); break;
      }
    });

    // ==================== TABS ====================
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => switchTab(tab.dataset.tab));
    });

    function switchTab(tabName) {
      currentTab = tabName;
      document.querySelectorAll('.tab').forEach(t => {
        t.classList.toggle('active', t.dataset.tab === tabName);
        t.setAttribute('aria-selected', t.dataset.tab === tabName);
      });
      document.querySelectorAll('.tab-content').forEach(tc => {
        tc.classList.toggle('hidden', tc.id !== 'tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
      });

      if (tabName === 'history') renderHistory();
      if (tabName === 'statistics') renderStatistics();
      if (tabName === 'database') renderCardDatabase();
    }

    // ==================== SPREAD INFO ====================
    function updateSpreadInfo() {
      const spreadType = spreadTypeEl.value;
      const spread = spreads[spreadType];
      const showInfo = showSpreadInfoCheckbox.checked;

      if (!showInfo) {
        spreadInfoEl.classList.add('hidden');
        return;
      }

      spreadInfoEl.classList.remove('hidden');
      document.getElementById('spreadInfoContent').textContent = spread.description;
      document.getElementById('spreadPositionsList').innerHTML = spread.positions.map((pos, idx) => 
        `<div class="spread-position-item">
          <span class="spread-position-num">${idx + 1}</span>
          <span>${escapeHTML(pos)}</span>
        </div>`
      ).join('');
    }

    spreadTypeEl.addEventListener('change', updateSpreadInfo);
    showSpreadInfoCheckbox.addEventListener('change', updateSpreadInfo);

    // ==================== DECK SELECTION ====================
    function getDeck(deckType) {
      switch (deckType) {
        case 'major': return [...majorArcana];
        case 'minor': return [...minorArcana];
        case 'court': return [...courtCards];
        case 'numbered': return [...numberedCards];
        default: return [...fullTarotCards];
      }
    }

    // ==================== CORE READING ====================
    function performReading(seedOverride) {
      const deckType = document.getElementById('deckType').value;
      const spreadType = spreadTypeEl.value;
      const spreadName = spreadTypeEl.options[spreadTypeEl.selectedIndex].dataset.spreadName;
      const question = document.getElementById('question').value.trim();

      const deck = getDeck(deckType);
      const seed = typeof seedOverride === 'number' ? seedOverride : getSeed();
      const rng = mulberry32(seed);
      const shuffled = shuffle(deck, rng);
      const spread = spreads[spreadType];
      const num = spread.positions.length;

      if (shuffled.length < num + 1) {
        showToast('牌組數量不足', 'error');
        return;
      }

      readBtn.disabled = true;
      readBtnText.innerHTML = '<span class="spinner"></span>';

      setTimeout(() => {
        const drawn = [];
        for (let i = 0; i < num; i++) {
          drawn.push({
            ...shuffled[i],
            position: spread.positions[i],
            orientation: rng() > 0.5 ? '正位' : '逆位'
          });
        }
        const bottomCard = {
          ...shuffled[shuffled.length - 1],
          position: '底牌',
          orientation: rng() > 0.5 ? '正位' : '逆位'
        };

        lastReadingData = { 
          id: Date.now(),
          seed, 
          deckType, 
          spreadType, 
          spreadName, 
          question, 
          drawnCards: drawn, 
          bottomCard, 
          timestamp: Date.now(),
          favorite: false,
          tags: [],
          note: ''
        };

        readingHistory.unshift(lastReadingData);
        if (readingHistory.length > 100) readingHistory = readingHistory.slice(0, 100);
        localStorage.setItem('readingHistory', JSON.stringify(readingHistory));

        renderResults(lastReadingData);
        updateURL({ seed, deck: deckType, spread: spreadType, q: question || null });
        
        readBtn.disabled = false;
        readBtnText.textContent = '開始占卜';

        requestAnimationFrame(() => {
          resultsEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
      }, 500);
    }

    function renderResults(data) {
      const { spreadName, question, drawnCards, bottomCard, seed, favorite, note } = data;

      resultsEl.innerHTML = `
        <div class="panel fade-in">
          <div class="results-header">
            <h3 class="results-title">你的占卜</h3>
            <div class="results-meta">
              <span class="badge ${favorite ? 'favorite' : ''}">${escapeHTML(spreadName)}</span>
              ${question ? `<span>${escapeHTML(question)}</span>` : ''}
            </div>
          </div>

          ${note ? `<div class="card-notes">${escapeHTML(note)}</div>` : ''}

          <div class="cards-grid">
            ${drawnCards.map(c => renderCard(c, false)).join('')}
            ${renderCard(bottomCard, true)}
          </div>

          <div class="btn-group">
            <button class="btn btn-tertiary" onclick="copyResults()">複製結果</button>
            <button class="btn btn-tertiary" onclick="generateShareImage()">生成分享圖</button>
            <button class="btn btn-tertiary" onclick="printReading()">列印</button>
          </div>
        </div>
      `;
    }

    function copyResults() {
      const { spreadName, question, drawnCards, bottomCard } = lastReadingData;
      const url = location.href;
      const text = [
        `${spreadName}${question ? ` - ${question}` : ''}`,
        '---',
        ...drawnCards.map(c => `${c.position}: ${c.name} (${c.orientation})`),
        `底牌: ${bottomCard.name} (${bottomCard.orientation})`,
        '',
        url
      ].join('\n');

      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
          showToast('已複製到剪貼簿');
        }).catch(() => {
          showToast('複製失敗', 'error');
        });
      }
    }

    function generateShareImage() {
      showToast('分享圖生成功能開發中', 'warning');
    }

    function printReading() {
      window.print();
    }

    // ==================== HISTORY ====================
    let historyFilters = {
      spread: '',
      tag: '',
      favorite: false
    };

    function renderHistory() {
      const list = document.getElementById('historyList');
      
      const spreads = [...new Set(readingHistory.map(r => r.spreadName))];
      document.getElementById('filterSpread').innerHTML = '<option value="">所有牌陣</option>' + 
        spreads.map(s => `<option value="${escapeHTML(s)}">${escapeHTML(s)}</option>`).join('');
      
      const tags = [...new Set(readingHistory.flatMap(r => r.tags || []))];
      document.getElementById('filterTag').innerHTML = '<option value="">所有標籤</option>' + 
        tags.map(t => `<option value="${escapeHTML(t)}">${escapeHTML(t)}</option>`).join('');

      let filtered = readingHistory.filter(item => {
        if (historyFilters.spread && item.spreadName !== historyFilters.spread) return false;
        if (historyFilters.tag && !item.tags?.includes(historyFilters.tag)) return false;
        if (historyFilters.favorite && !item.favorite) return false;
        return true;
      });

      if (filtered.length === 0) {
        list.innerHTML = '<div class="history-empty">尚無符合條件的記錄</div>';
        return;
      }

      list.innerHTML = filtered.map(item => `
        <div class="history-item ${item.favorite ? 'favorite' : ''}" data-id="${item.id}">
          <div class="history-header">
            <span class="history-spread">${escapeHTML(item.spreadName)}</span>
            <span class="history-time">${formatDate(item.timestamp)}</span>
          </div>
          ${item.question ? `<div class="history-question">${escapeHTML(item.question)}</div>` : ''}
          ${item.tags?.length ? `<div class="tags">${item.tags.map(t => `<span class="tag">${escapeHTML(t)}</span>`).join('')}</div>` : ''}
          <div class="history-actions">
            <button class="btn btn-tertiary btn-sm" onclick="viewReading(${item.id})">查看</button>
            <button class="btn btn-tertiary btn-sm" onclick="toggleFavorite(${item.id})">${item.favorite ? '取消收藏' : '⭐ 收藏'}</button>
            <button class="btn btn-tertiary btn-sm" onclick="openNoteModal(${item.id})">筆記</button>
            <button class="btn btn-tertiary btn-sm" onclick="openTagModal(${item.id})">標籤</button>
            <button class="btn btn-tertiary btn-sm" onclick="deleteReading(${item.id})">刪除</button>
          </div>
        </div>
      `).join('');
    }

    document.getElementById('filterSpread').addEventListener('change', (e) => {
      historyFilters.spread = e.target.value;
      renderHistory();
    });

    document.getElementById('filterTag').addEventListener('change', (e) => {
      historyFilters.tag = e.target.value;
      renderHistory();
    });

    document.getElementById('filterFavorite').addEventListener('click', () => {
      historyFilters.favorite = !historyFilters.favorite;
      document.getElementById('filterFavorite').style.background = historyFilters.favorite ? 'var(--accent)' : '';
      document.getElementById('filterFavorite').style.color = historyFilters.favorite ? 'white' : '';
      renderHistory();
    });

    function viewReading(id) {
      const reading = readingHistory.find(r => r.id === id);
      if (reading) {
        lastReadingData = reading;
        renderResults(reading);
        switchTab('reading');
      }
    }

    function toggleFavorite(id) {
      const reading = readingHistory.find(r => r.id === id);
      if (reading) {
        reading.favorite = !reading.favorite;
        localStorage.setItem('readingHistory', JSON.stringify(readingHistory));
        renderHistory();
        showToast(reading.favorite ? '已加入收藏' : '已取消收藏');
      }
    }

    function deleteReading(id) {
      if (confirm('確定要刪除此占卜記錄嗎？')) {
        readingHistory = readingHistory.filter(r => r.id !== id);
        localStorage.setItem('readingHistory', JSON.stringify(readingHistory));
        renderHistory();
        showToast('已刪除記錄');
      }
    }

    function openNoteModal(id) {
      currentEditingId = id;
      const reading = readingHistory.find(r => r.id === id);
      document.getElementById('noteText').value = reading?.note || '';
      document.getElementById('noteModal').classList.add('show');
    }

    function closeNoteModal() {
      document.getElementById('noteModal').classList.remove('show');
      currentEditingId = null;
    }

    function saveNote() {
      const reading = readingHistory.find(r => r.id === currentEditingId);
      if (reading) {
        reading.note = document.getElementById('noteText').value;
        localStorage.setItem('readingHistory', JSON.stringify(readingHistory));
        closeNoteModal();
        renderHistory();
        showToast('筆記已儲存');
      }
    }

    function openTagModal(id) {
      currentEditingId = id;
      const reading = readingHistory.find(r => r.id === id);
      
      document.getElementById('commonTags').innerHTML = commonTags.map(tag => {
        const active = reading?.tags?.includes(tag) ? 'active' : '';
        return `<span class="tag ${active}" onclick="toggleTagSelection('${tag}')">${tag}</span>`;
      }).join('');
      
      document.getElementById('tagModal').classList.add('show');
    }

    function closeTagModal() {
      document.getElementById('tagModal').classList.remove('show');
      document.getElementById('customTag').value = '';
      currentEditingId = null;
    }

    function toggleTagSelection(tag) {
      const reading = readingHistory.find(r => r.id === currentEditingId);
      if (!reading) return;
      
      if (!reading.tags) reading.tags = [];
      
      const index = reading.tags.indexOf(tag);
      if (index > -1) {
        reading.tags.splice(index, 1);
      } else {
        reading.tags.push(tag);
      }
      
      openTagModal(currentEditingId);
    }

    function saveTag() {
      const reading = readingHistory.find(r => r.id === currentEditingId);
      const customTag = document.getElementById('customTag').value.trim();
      
      if (customTag && !reading.tags.includes(customTag)) {
        reading.tags.push(customTag);
      }
      
      localStorage.setItem('readingHistory', JSON.stringify(readingHistory));
      closeTagModal();
      renderHistory();
      showToast('標籤已更新');
    }

    document.getElementById('clearHistory').addEventListener('click', () => {
      if (confirm('確定要清除所有記錄嗎？')) {
        readingHistory = [];
        localStorage.setItem('readingHistory', '[]');
        renderHistory();
        showToast('已清除所有記錄');
      }
    });

    // ==================== STATISTICS ====================
    function renderStatistics() {
      const content = document.getElementById('statisticsContent');
      if (readingHistory.length === 0) {
        content.innerHTML = '<div class="history-empty">尚無統計資料</div>';
        return;
      }

      let totalCards = 0, upright = 0, reversed = 0;
      const cardCount = {}, suitCount = {}, spreadCount = {};
      let favoriteCount = 0;

      readingHistory.forEach(r => {
        const cards = [...r.drawnCards, r.bottomCard];
        totalCards += cards.length;
        spreadCount[r.spreadName] = (spreadCount[r.spreadName] || 0) + 1;
        if (r.favorite) favoriteCount++;

        cards.forEach(c => {
          if (c.orientation === '正位') upright++; else reversed++;
          cardCount[c.name] = (cardCount[c.name] || 0) + 1;
          suitCount[c.suit] = (suitCount[c.suit] || 0) + 1;
        });
      });

      const topCards = Object.entries(cardCount).sort((a, b) => b[1] - a[1]).slice(0, 5);
      const topSpreads = Object.entries(spreadCount).sort((a, b) => b[1] - a[1]).slice(0, 5);

      content.innerHTML = `
        <div class="stat-card">
          <div class="stat-title">占卜次數</div>
          <div class="stat-value">${readingHistory.length}</div>
          <div class="stat-label">次</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">總抽牌數</div>
          <div class="stat-value">${totalCards}</div>
          <div class="stat-label">張</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">正位比例</div>
          <div class="stat-value">${((upright/totalCards)*100).toFixed(0)}%</div>
          <div class="stat-label">${upright} 張</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">逆位比例</div>
          <div class="stat-value">${((reversed/totalCards)*100).toFixed(0)}%</div>
          <div class="stat-label">${reversed} 張</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">收藏數量</div>
          <div class="stat-value">${favoriteCount}</div>
          <div class="stat-label">個收藏</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">平均每次</div>
          <div class="stat-value">${(totalCards / readingHistory.length).toFixed(1)}</div>
          <div class="stat-label">張牌</div>
        </div>

        <div class="stat-card wide">
          <div class="stat-title">花色分布</div>
          <div class="pie-chart">
            <canvas id="suitPieChart" class="pie-canvas" width="240" height="240"></canvas>
            <div class="pie-legend" id="suitLegend"></div>
          </div>
        </div>

        <div class="stat-card wide">
          <div class="stat-title">常用牌陣</div>
          <div class="stat-list">
            ${topSpreads.map(([name, count]) => `
              <div class="stat-item">
                <span class="stat-item-name">${escapeHTML(name)}</span>
                <span class="stat-item-count">${count} 次 (${((count / readingHistory.length) * 100).toFixed(0)}%)</span>
              </div>
            `).join('')}
          </div>
        </div>

        <div class="stat-card wide">
          <div class="stat-title">常見牌卡</div>
          <div class="stat-list">
            ${topCards.map(([name, count]) => `
              <div class="stat-item">
                <span class="stat-item-name">${escapeHTML(name)}</span>
                <span class="stat-item-count">${count} 次 (${((count / totalCards) * 100).toFixed(1)}%)</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;

      setTimeout(() => drawPieChart('suitPieChart', suitCount, 'suitLegend'), 100);
    }

    function drawPieChart(canvasId, data, legendId) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = Math.min(centerX, centerY) - 20;

      const colors = ['#007aff', '#34c759', '#ff9500', '#ff3b30', '#af52de', '#5ac8fa'];
      const total = Object.values(data).reduce((a, b) => a + b, 0);
      
      let currentAngle = -Math.PI / 2;
      const entries = Object.entries(data);
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      entries.forEach(([key, value], index) => {
        const sliceAngle = (value / total) * 2 * Math.PI;
        
        ctx.beginPath();
        ctx.fillStyle = colors[index % colors.length];
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
        ctx.closePath();
        ctx.fill();
        
        currentAngle += sliceAngle;
      });

      const legend = document.getElementById(legendId);
      if (legend) {
        legend.innerHTML = entries.map(([key, value], index) => `
          <div class="pie-legend-item">
            <div class="pie-legend-color" style="background: ${colors[index % colors.length]}"></div>
            <span>${key}: ${value} (${((value / total) * 100).toFixed(0)}%)</span>
          </div>
        `).join('');
      }
    }

    // ==================== CARD DATABASE ====================
    const debouncedSearch = debounce((filter) => {
      renderCardDatabaseFiltered(filter);
    }, 300);

    function renderCardDatabase() {
      document.getElementById('cardSearch').addEventListener('input', (e) => {
        debouncedSearch(e.target.value);
      });
      renderCardDatabaseFiltered('');
    }

    function renderCardDatabaseFiltered(filter = '') {
      const grid = document.getElementById('cardDatabaseGrid');
      const filtered = fullTarotCards.filter(c =>
        c.name.includes(filter) || c.englishName.toLowerCase().includes(filter.toLowerCase())
      );

      grid.innerHTML = filtered.map(c => `
        <div class="card-db-item">
          <div class="card-db-number">${escapeHTML(c.number)}</div>
          <div class="card-db-name">${escapeHTML(c.name)}</div>
          <div class="card-db-english">${escapeHTML(c.englishName)}</div>
          <span class="card-db-suit">${escapeHTML(c.suit)}</span>
        </div>
      `).join('');
    }

    // ==================== SETTINGS ====================
    document.getElementById('exportData').addEventListener('click', () => {
      const data = { 
        version: '5.1.0', 
        history: readingHistory, 
        exportDate: new Date().toISOString(),
        visualStyle: visualStyle
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `tarot-backup-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('資料已匯出');
    });

    document.getElementById('importData').addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);
            if (data.history && Array.isArray(data.history)) {
              readingHistory = data.history;
              localStorage.setItem('readingHistory', JSON.stringify(readingHistory));
              if (data.visualStyle) {
                setVisualStyle(data.visualStyle);
              }
              showToast('資料匯入成功');
            } else {
              showToast('檔案格式錯誤', 'error');
            }
          } catch {
            showToast('檔案解析失敗', 'error');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    });

    // ==================== SHARE ====================
    shareBtn.addEventListener('click', () => {
      const url = location.href;
      if (navigator.share) {
        navigator.share({
          title: '塔羅占卜',
          text: '查看我的占卜結果',
          url: url
        }).catch(() => {});
      } else if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(() => {
          showToast('連結已複製');
        });
      }
    });

    // ==================== READ BUTTON ====================
    readBtn.addEventListener('click', () => performReading());

    // ==================== FOOTER LINKS ====================
    document.getElementById('linkAbout').addEventListener('click', (e) => {
      e.preventDefault();
      showToast('v5.1.0 - CSS 全面優化');
    });

    document.getElementById('linkPrivacy').addEventListener('click', (e) => {
      e.preventDefault();
      alert('隱私政策\n\n✓ 不收集任何資料\n✓ 不使用追蹤工具\n✓ 完全本地運作\n✓ API 模式僅載入圖片');
    });

    // ==================== INIT ====================
    (function init() {
      const url = new URL(location.href);
      const deck = url.searchParams.get('deck');
      const spread = url.searchParams.get('spread');
      const seed = url.searchParams.get('seed');
      const q = url.searchParams.get('q');

      if (deck) document.getElementById('deckType').value = deck;
      if (spread) spreadTypeEl.value = spread;
      if (q) document.getElementById('question').value = decodeURIComponent(q);

      updateSpreadInfo();
      
      // 設定初始視覺樣式
      setVisualStyle(visualStyle);
      
      if (seed) performReading(Number(seed));

      // 模態窗口點擊外部關閉
      document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            overlay.classList.remove('show');
          }
        });
      });

      // 模態窗口開關時控制 body overflow
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.target.classList.contains('modal-overlay')) {
            if (mutation.target.classList.contains('show')) {
              document.body.style.overflow = 'hidden';
            } else {
              document.body.style.overflow = '';
            }
          }
        });
      });

      document.querySelectorAll('.modal-overlay').forEach(el => {
        observer.observe(el, { attributes: true, attributeFilter: ['class'] });
      });
    })();
  </script>
</body>
</html>
